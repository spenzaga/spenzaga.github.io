<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Secure Exam (Demo)</title>
  <style>
    html,body { height:100%; margin:0; font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial; background:#111; color:#eee; }
    .container { display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; gap:16px; padding:20px; }
    button { padding:12px 20px; border-radius:8px; border:0; cursor:pointer; font-size:16px; }
    #overlay { position:fixed; inset:0; background:rgba(0,0,0,0.88); color:#fff; display:none; align-items:center; justify-content:center; z-index:9999; text-align:center; padding:20px; }
    #overlay.show { display:flex; }
    #warning { background:#2b2b2b; padding:20px; border-radius:8px; max-width:720px; }
    .hidden { display:none !important; }
    .notice { font-size:14px; color:#ddd; opacity:0.9 }
    .exam-content { max-width:980px; width:100%; background:#0f1720; padding:20px; border-radius:8px; box-shadow:0 6px 24px rgba(0,0,0,0.6); }
  </style>
</head>
<body>
  <div id="overlay"><div id="warning"><h2>Exam Locked</h2><p id="overlay-text">Tampilan ini muncul karena halaman tidak aktif atau keluar dari mode ujian. Silakan kembali ke tab dan tekan "Resume".</p><div style="margin-top:12px"><button id="resumeBtn">Resume</button></div></div>

  <div class="container" id="startScreen">
    <h1>Exam Browser - Demo</h1>
    <p class="notice">Klik tombol di bawah untuk memulai. Aplikasi akan meminta mode layar penuh dan mengunci beberapa fungsi browser.</p>
    <button id="startBtn">Mulai Ujian (Masuk Fullscreen)</button>
  </div>

  <div id="exam" class="hidden">
    <div class="container">
      <div class="exam-content" id="examArea" tabindex="0">
        <h2>Soal (Contoh)</h2>
        <p>1. Apa warna bendera Indonesia?</p>
        <ol type="a">
          <li>Merah Putih</li>
          <li>Biru Putih</li>
          <li>Hijau Kuning</li>
        </ol>
        <p style="margin-top:24px" class="notice">Tekan tombol di kanan bawah untuk mengakhiri ujian.</p>
      </div>

      <div style="display:flex; gap:8px; align-items:center;">
        <button id="endBtn">Selesai Ujian</button>
      </div>
    </div>
  </div>

<script>
(() => {
  // -- Config --
  const LOG_ENDPOINT = '/log'; // ganti dengan endpoint server Anda

  // -- Util: log to server (best-effort) --
  async function sendLog(type, info = {}) {
    const payload = { ts: new Date().toISOString(), type, info };
    // best-effort: don't block UI
    try {
      await fetch(LOG_ENDPOINT, {
        method: 'POST',
        headers: {'content-type': 'application/json'},
        body: JSON.stringify(payload),
      });
    } catch (e) {
      // ignore
      console.debug('log fail', e);
    }
  }

  // -- UI elements --
  const startBtn = document.getElementById('startBtn');
  const resumeBtn = document.getElementById('resumeBtn');
  const startScreen = document.getElementById('startScreen');
  const exam = document.getElementById('exam');
  const overlay = document.getElementById('overlay');
  const overlayText = document.getElementById('overlay-text');
  const endBtn = document.getElementById('endBtn');
  const examArea = document.getElementById('examArea');

  // -- Fullscreen helper --
  async function requestFullscreen() {
    try {
      if (document.fullscreenElement == null) {
        await document.documentElement.requestFullscreen({navigationUI: 'hide'});
      }
    } catch (e) {
      console.warn('Fullscreen failed', e);
    }
  }

  // -- Start exam --
  startBtn.addEventListener('click', async () => {
    startScreen.classList.add('hidden');
    exam.classList.remove('hidden');
    await requestFullscreen();
    examArea.focus();
    sendLog('exam_start');
  });

  // -- End exam --
  endBtn.addEventListener('click', () => {
    sendLog('exam_end');
    exitExam('Ujian selesai. Terima kasih.');
  });

  function exitExam(message) {
    if (document.fullscreenElement) {
      document.exitFullscreen().catch(()=>{});
    }
    overlay.classList.remove('show');
    startScreen.classList.remove('hidden');
    exam.classList.add('hidden');
    alert(message);
  }

  // -- Resume button (on overlay) --
  resumeBtn.addEventListener('click', async () => {
    overlay.classList.remove('show');
    await requestFullscreen();
    sendLog('resume_by_user');
  });

  // -- Detect visibility change (tab switch / minimize) --
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'hidden') {
      // page not visible => show overlay when user returns
      sendLog('visibility_hidden');
    } else {
      sendLog('visibility_visible');
      // if user returned, show the overlay to force resume
      overlayText.textContent = 'Anda kembali ke tab. Tekan Resume untuk melanjutkan ujian.';
      overlay.classList.add('show');
    }
  });

  // -- Warn before unload (closing tab) --
  window.addEventListener('beforeunload', (e) => {
    // Log attempt and show a browser confirmation
    sendLog('beforeunload_attempt');
    const msg = 'Anda akan meninggalkan halaman ujian. Progress mungkin tidak tersimpan.';
    e.preventDefault();
    e.returnValue = msg;
    return msg;
  });

  // -- Block context menu, selection, copy/paste, drag/drop --
  document.addEventListener('contextmenu', e => { e.preventDefault(); sendLog('contextmenu_block'); });
  document.addEventListener('selectstart', e => { e.preventDefault(); });
  ['copy','cut','paste'].forEach(ev =>
    document.addEventListener(ev, e => { e.preventDefault(); sendLog(ev + '_blocked'); })
  );
  window.addEventListener('drop', e => { e.preventDefault(); });

  // -- Attempt to intercept window.open --
  (function(){
    const origOpen = window.open;
    window.open = function(...args) {
      sendLog('window_open_blocked',{args});
      // optionally return a dummy window-like object to avoid JS errors
      return { closed: true };
    };
  })();

  // -- Block many common shortcuts (best-effort) --
  document.addEventListener('keydown', (e) => {
    // combinations to block (Ctrl/Cmd + key)
    const ctrlOrCmd = e.ctrlKey || e.metaKey;
    // Block: Ctrl+T (new tab), Ctrl+N (new window), Ctrl+W (close tab), Ctrl+Shift+I / F12 (devtools), Ctrl+Shift+C, Ctrl+Shift+J
    if ((ctrlOrCmd && (e.key === 't' || e.key === 'T' || e.key === 'n' || e.key === 'N' || e.key === 'w' || e.key === 'W')) ||
        (ctrlOrCmd && e.shiftKey && (e.key === 'I' || e.key === 'C' || e.key === 'J')) ||
        e.key === 'F12') {
      e.preventDefault();
      e.stopPropagation();
      sendLog('shortcut_blocked',{key: e.key, ctrl: e.ctrlKey, meta: e.metaKey, shift: e.shiftKey});
      // show a small warning briefly
      flashMessage('Shortcut dinonaktifkan selama ujian.');
    }
  }, {capture:true});

  // small transient message
  function flashMessage(text) {
    const el = document.createElement('div');
    el.textContent = text;
    Object.assign(el.style, { position:'fixed', right:'20px', bottom:'20px', padding:'10px 14px', background:'#222', borderRadius:'8px', color:'#fff', zIndex:9999 });
    document.body.appendChild(el);
    setTimeout(()=> el.remove(), 2200);
  }

  // -- Detect devtools (heuristic) and log --
  let devtoolsOpen = false;
  setInterval(() => {
    // simple heuristic: measure small time discrepancies or check window.outerWidth - innerWidth
    const threshold = 160;
    const detected = (window.outerWidth - window.innerWidth > threshold) || (window.outerHeight - window.innerHeight > threshold);
    if (detected && !devtoolsOpen) {
      devtoolsOpen = true;
      sendLog('devtools_open_detected');
      flashMessage('DevTools terdeteksi â€” ini dilarang selama ujian.');
    } else if (!detected && devtoolsOpen) {
      devtoolsOpen = false;
      sendLog('devtools_closed');
    }
  }, 1000);

  // -- Accessibility: focus exam area on load --
  window.addEventListener('load', () => {
    examArea.setAttribute('tabindex', '0');
  });

  // -- Inform server that page loaded (for monitoring) --
  sendLog('page_loaded', {pathname: location.pathname});

})();
</script>
</body>
</html>

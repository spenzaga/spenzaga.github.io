<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CBT SMP Negeri 1 Purbalingga</title>
  <link rel="icon" type="image/x-icon" href="https://www.smpn1purbalingga.sch.id/favicon.ico">
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    body {
      box-sizing: border-box;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }
    
    * {
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    
    input, textarea {
      -webkit-user-select: text;
      -moz-user-select: text;
      -ms-user-select: text;
      user-select: text;
    }
    
    .question-card {
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      animation: slideIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(40px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    .answer-option {
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .answer-option::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s;
    }
    
    .answer-option:hover::before {
      left: 100%;
    }
    
    .answer-option:hover {
      transform: translateX(8px) scale(1.02);
      box-shadow: 0 15px 35px rgba(0,0,0,0.12);
    }
    
    .answer-option.selected {
      border-width: 3px;
      transform: scale(1.04);
      box-shadow: 0 15px 40px rgba(37, 99, 235, 0.25);
      animation: selectPulse 0.4s ease;
    }
    
    @keyframes selectPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.06); }
      100% { transform: scale(1.04); }
    }
    
    .loading-spinner {
      border: 4px solid rgba(255, 255, 255, 0.25);
      border-radius: 50%;
      border-top-color: white;
      border-right-color: white;
      width: 28px;
      height: 28px;
      animation: spin 0.7s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
      from { 
        opacity: 0; 
        transform: translateY(20px);
      }
      to { 
        opacity: 1; 
        transform: translateY(0);
      }
    }
    
    .pulse-animation {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.7;
      }
    }
    
    .dragging {
      opacity: 0.5;
      transform: rotate(2deg);
    }
    
    .drag-over {
      border-color: #2563eb;
      background-color: #eff6ff;
      transform: scale(1.05);
    }
    
    .floating-nav {
      position: fixed;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      z-index: 1000;
      transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      box-shadow: -8px 0 32px rgba(0,0,0,0.18);
    }
    
    .floating-nav.hidden-nav {
      right: -320px;
      opacity: 0;
    }
    
    .toggle-nav-btn {
      position: fixed;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      z-index: 1001;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 6px 20px rgba(37, 99, 235, 0.3);
    }
    
    .toggle-nav-btn:hover {
      transform: translateY(-50%) scale(1.15) rotate(5deg);
      box-shadow: 0 8px 25px rgba(37, 99, 235, 0.4);
    }
    
    .toggle-nav-btn:active {
      transform: translateY(-50%) scale(1.05);
    }
    
    .nav-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
    }
    
    .nav-item {
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      font-weight: 700;
      position: relative;
    }
    
    .nav-item:hover {
      transform: scale(1.2) rotate(8deg);
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }
    
    .nav-item.answered {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }
    
    .nav-item.answered::after {
      content: '‚úì';
      position: absolute;
      top: -6px;
      right: -6px;
      background: linear-gradient(135deg, #ffffff 0%, #f0fdf4 100%);
      color: #10b981;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: bold;
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
      animation: checkBounce 0.5s ease;
    }
    
    @keyframes checkBounce {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.3); }
    }
    
    .nav-item.current {
      border: 3px solid #2563eb;
      box-shadow: 0 0 20px rgba(37, 99, 235, 0.5);
      animation: currentPulse 2s ease-in-out infinite;
    }
    
    @keyframes currentPulse {
      0%, 100% {
        box-shadow: 0 0 20px rgba(37, 99, 235, 0.5);
      }
      50% {
        box-shadow: 0 0 30px rgba(37, 99, 235, 0.8);
      }
    }
    
    .match-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    .match-item {
      padding: 18px;
      border: 3px solid #e2e8f0;
      border-radius: 14px;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
      position: relative;
      overflow: hidden;
    }
    
    .match-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(37, 99, 235, 0.1), transparent);
      transition: left 0.5s;
    }
    
    .match-item:hover {
      transform: translateY(-6px);
      box-shadow: 0 12px 28px rgba(0,0,0,0.12);
      border-color: #94a3b8;
    }
    
    .match-item:hover::before {
      left: 100%;
    }
    
    .match-item.selected {
      border-color: #2563eb;
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      transform: scale(1.06);
      box-shadow: 0 8px 24px rgba(37, 99, 235, 0.3);
      animation: matchSelect 0.3s ease;
    }
    
    @keyframes matchSelect {
      0% { transform: scale(1); }
      50% { transform: scale(1.08); }
      100% { transform: scale(1.06); }
    }
    
    .match-item.matched {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      border-color: #10b981;
      transform: scale(0.98);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
      animation: matchSuccess 0.5s ease;
    }
    
    @keyframes matchSuccess {
      0% { transform: scale(1.06); }
      50% { transform: scale(1.1); }
      100% { transform: scale(0.98); }
    }
    
    .warning-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.95);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      animation: fadeIn 0.3s ease;
    }
    
    .security-warning {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
      color: white;
      padding: 18px;
      text-align: center;
      font-weight: bold;
      z-index: 9999;
      animation: slideDown 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55), warningPulse 1s ease-in-out infinite;
      box-shadow: 0 6px 20px rgba(220, 38, 38, 0.5);
      border-bottom: 3px solid rgba(255, 255, 255, 0.3);
    }
    
    @keyframes slideDown {
      from { 
        transform: translateY(-100%);
        opacity: 0;
      }
      to { 
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    @keyframes warningPulse {
      0%, 100% {
        box-shadow: 0 6px 20px rgba(220, 38, 38, 0.5);
      }
      50% {
        box-shadow: 0 6px 30px rgba(220, 38, 38, 0.7);
      }
    }
    
    .review-answer {
      padding: 18px;
      border-radius: 14px;
      margin-bottom: 12px;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .review-answer::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      height: 100%;
      width: 4px;
      background: currentColor;
      transform: scaleY(0);
      transition: transform 0.3s ease;
    }
    
    .review-answer:hover {
      transform: translateX(8px);
    }
    
    .review-answer:hover::before {
      transform: scaleY(1);
    }
    
    .review-answer.correct {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      border: 3px solid #10b981;
      box-shadow: 0 6px 16px rgba(16, 185, 129, 0.25);
      color: #10b981;
    }
    
    .review-answer.incorrect {
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      border: 3px solid #dc2626;
      box-shadow: 0 6px 16px rgba(220, 38, 38, 0.25);
      color: #dc2626;
    }
    
    .review-answer.user-answer {
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      border: 3px solid #2563eb;
      box-shadow: 0 6px 16px rgba(37, 99, 235, 0.25);
      color: #2563eb;
    }
    
    .timer-display {
      font-family: 'Courier New', monospace;
      font-size: 22px;
      font-weight: bold;
      padding: 14px 24px;
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      color: white;
      border-radius: 16px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.25);
      display: inline-flex;
      align-items: center;
      gap: 10px;
      border: 2px solid rgba(255,255,255,0.1);
      animation: timerGlow 3s ease-in-out infinite;
    }
    
    @keyframes timerGlow {
      0%, 100% {
        box-shadow: 0 6px 20px rgba(0,0,0,0.25);
      }
      50% {
        box-shadow: 0 6px 25px rgba(37, 99, 235, 0.4);
      }
    }
    
    .score-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 140px;
      height: 140px;
      border-radius: 50%;
      font-size: 42px;
      font-weight: bold;
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      color: white;
      box-shadow: 0 15px 40px rgba(37, 99, 235, 0.4);
      animation: scalePulse 2.5s ease-in-out infinite;
      border: 5px solid white;
      position: relative;
    }
    
    .score-badge::before {
      content: '';
      position: absolute;
      inset: -10px;
      border-radius: 50%;
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      opacity: 0.3;
      animation: ringPulse 2.5s ease-in-out infinite;
    }
    
    @keyframes scalePulse {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 15px 40px rgba(37, 99, 235, 0.4);
      }
      50% {
        transform: scale(1.08);
        box-shadow: 0 20px 50px rgba(37, 99, 235, 0.5);
      }
    }
    
    @keyframes ringPulse {
      0%, 100% {
        transform: scale(1);
        opacity: 0.3;
      }
      50% {
        transform: scale(1.15);
        opacity: 0;
      }
    }
    
    .badge-excellent {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);
    }
    
    .badge-good {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      box-shadow: 0 10px 30px rgba(37, 99, 235, 0.4);
    }
    
    .badge-pass {
      background: linear-gradient(135deg, #eab308 0%, #ca8a04 100%);
      box-shadow: 0 10px 30px rgba(234, 179, 8, 0.4);
    }
    
    .badge-fail {
      background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
      box-shadow: 0 10px 30px rgba(220, 38, 38, 0.4);
    }
    
    .progress-ring {
      transform: rotate(-90deg);
    }
    
    .progress-ring-circle {
      transition: stroke-dashoffset 0.5s ease;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      border-radius: 20px;
      padding: 24px;
      text-align: center;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      border: 2px solid #bae6fd;
      position: relative;
      overflow: hidden;
    }
    
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
      transition: left 0.6s;
    }
    
    .stat-card:hover {
      transform: translateY(-8px) scale(1.03);
      box-shadow: 0 15px 35px rgba(37, 99, 235, 0.2);
      border-color: #3b82f6;
    }
    
    .stat-card:hover::before {
      left: 100%;
    }
    
    .btn-gradient {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .btn-gradient::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255,255,255,0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }
    
    .btn-gradient:hover::before {
      width: 300px;
      height: 300px;
    }
    
    .btn-gradient:hover {
      background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
      transform: translateY(-3px);
      box-shadow: 0 15px 35px rgba(37, 99, 235, 0.4);
    }
    
    .btn-gradient:active {
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(37, 99, 235, 0.3);
    }
    
    .btn-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      position: relative;
      overflow: hidden;
    }
    
    .btn-success::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255,255,255,0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }
    
    .btn-success:hover::before {
      width: 300px;
      height: 300px;
    }
    
    .btn-success:hover {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
      transform: translateY(-3px);
      box-shadow: 0 15px 35px rgba(16, 185, 129, 0.4);
    }
    
    .btn-success:active {
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
    }
    
    .glass-effect {
      background: rgba(255, 255, 255, 0.97);
      backdrop-filter: blur(15px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.4);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
    }
    
    .shimmer {
      position: relative;
      overflow: hidden;
    }
    
    .shimmer::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
      to {
        left: 100%;
      }
    }
    
    .toast-notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 12px;
      color: white;
      font-weight: 600;
      z-index: 9999;
      animation: slideInRight 0.3s ease, slideOutRight 0.3s ease 2.7s;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    
    @keyframes slideInRight {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full">
  <div id="app" class="w-full h-full"></div>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBiC7S29mWNiNyusbIwnR-Pha6aIZZTA0o",
      authDomain: "quiziz-30f51.firebaseapp.com",
      databaseURL: "https://quiziz-30f51-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "quiziz-30f51",
      storageBucket: "quiziz-30f51.firebasestorage.app",
      messagingSenderId: "335258259474",
      appId: "1:335258259474:web:a89f78bcb592481fb9c8cb",
      measurementId: "G-X6C0SV86SV"
    };
    
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const defaultConfig = {
      background_color: "#f0f9ff",
      card_color: "#ffffff",
      primary_color: "#2563eb",
      text_color: "#1e293b",
      success_color: "#16a34a",
      app_title: "CBT SMP Negeri 1 Purbalingga",
      welcome_text: "Selamat datang di aplikasi ujian berbasis komputer",
      instruction_text: "Baca setiap soal dengan teliti dan pilih jawaban yang tepat",
      honesty_statement: "Saya berjanji akan mengerjakan ujian ini dengan jujur dan tidak akan mencontek",
      font_family: "Inter",
      font_size: 16
    };

    let currentStudent = null;
    let currentQuestionIndex = 0;
    let userAnswers = {};
    let isSubmitting = false;
    let showNav = false;
    let examStartTime = null;
    let existingScore = null;
    let securityWarnings = 0;
    let isExamMode = false;
    let timerInterval = null;
    let questionsData = [];
    let appConfig = {...defaultConfig};

    async function loadConfigFromFirebase() {
      try {
        const snapshot = await database.ref('config').once('value');
        if (snapshot.exists()) {
          const firebaseConfig = snapshot.val();
          appConfig = {...defaultConfig, ...firebaseConfig};
          return appConfig;
        }
        return appConfig;
      } catch (error) {
        console.error('Error loading config:', error);
        return appConfig;
      }
    }

    async function loadQuestionsFromFirebase() {
      try {
        const snapshot = await database.ref('questions').once('value');
        if (snapshot.exists()) {
          const questionsObj = snapshot.val();
          questionsData = Object.values(questionsObj);
          return questionsData;
        } else {
          questionsData = [];
          showToast('Tidak ada data soal di Firebase', 'warning');
          return [];
        }
      } catch (error) {
        console.error('Error loading questions:', error);
        showToast('Gagal memuat soal dari Firebase', 'error');
        return [];
      }
    }

    function setupSecurityMeasures() {
      document.addEventListener('keydown', (e) => {
        if (!isExamMode) return;
        
        if (e.key === 'PrintScreen' || 
            (e.ctrlKey && e.shiftKey && (e.key === 'S' || e.key === 's')) ||
            (e.metaKey && e.shiftKey && (e.key === '3' || e.key === '4' || e.key === '5'))) {
          e.preventDefault();
          showSecurityWarning('‚ö†Ô∏è Screenshot terdeteksi! Peringatan ke-' + (++securityWarnings));
        }
        
        if ((e.ctrlKey || e.metaKey) && (e.key === 't' || e.key === 'T' || e.key === 'n' || e.key === 'N')) {
          e.preventDefault();
          showSecurityWarning('‚ö†Ô∏è Percobaan membuka tab baru! Peringatan ke-' + (++securityWarnings));
        }
      });
      
      document.addEventListener('contextmenu', (e) => {
        if (isExamMode) {
          e.preventDefault();
          showToast('Klik kanan dinonaktifkan selama ujian', 'warning');
        }
      });
      
      document.addEventListener('visibilitychange', () => {
        if (isExamMode && document.hidden) {
          showSecurityWarning('‚ö†Ô∏è Jangan meninggalkan halaman! Peringatan ke-' + (++securityWarnings));
        }
      });
      
      window.addEventListener('blur', () => {
        if (isExamMode) {
          showSecurityWarning('‚ö†Ô∏è Tetap fokus pada ujian! Peringatan ke-' + (++securityWarnings));
        }
      });
      
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          mutation.addedNodes.forEach((node) => {
            if (node.nodeType === 1) {
              const translateElements = node.querySelectorAll ? 
                node.querySelectorAll('[class*="translate"], [id*="translate"], [class*="google"], [id*="google"]') : [];
              
              if (node.className && (node.className.includes('translate') || node.className.includes('google'))) {
                node.remove();
                showSecurityWarning('üö´ Google Translate terdeteksi dan diblokir');
              }
              
              translateElements.forEach(el => {
                el.remove();
                showSecurityWarning('üö´ Google Translate terdeteksi dan diblokir');
              });
            }
          });
        });
      });
      
      observer.observe(document.body, {
        childList: true,
        subtree: true
      });
    }

    function showSecurityWarning(message) {
      const warning = document.createElement('div');
      warning.className = 'security-warning';
      warning.innerHTML = `
        <div class="flex items-center justify-center gap-3">
          <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
          </svg>
          <span>${message}</span>
        </div>
      `;
      document.body.appendChild(warning);
      
      setTimeout(() => {
        warning.style.animation = 'slideDown 0.4s ease reverse';
        setTimeout(() => warning.remove(), 400);
      }, 3000);
    }

    function showToast(message, type = 'info') {
      const colors = {
        success: 'background: linear-gradient(135deg, #10b981 0%, #059669 100%);',
        error: 'background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);',
        warning: 'background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);',
        info: 'background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);'
      };
      
      const toast = document.createElement('div');
      toast.className = 'toast-notification';
      toast.style = colors[type] || colors.info;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    function startTimer() {
      if (timerInterval) clearInterval(timerInterval);
      
      timerInterval = setInterval(() => {
        if (!examStartTime) return;
        
        const now = new Date();
        const elapsed = Math.floor((now - examStartTime) / 1000);
        const hours = Math.floor(elapsed / 3600);
        const minutes = Math.floor((elapsed % 3600) / 60);
        const seconds = elapsed % 60;
        
        const timerElement = document.getElementById('examTimer');
        if (timerElement) {
          timerElement.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
      }, 1000);
    }

    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    function applyConfig() {
      const baseSize = appConfig.font_size;
      const customFont = appConfig.font_family;
      const fontStack = `${customFont}, system-ui, -apple-system, sans-serif`;
      
      document.body.style.backgroundColor = appConfig.background_color;
      document.body.style.fontFamily = fontStack;
      document.body.style.fontSize = `${baseSize}px`;
      
      const titleElements = document.querySelectorAll('.app-title');
      titleElements.forEach(el => {
        el.textContent = appConfig.app_title;
        el.style.color = appConfig.text_color;
        el.style.fontSize = `${baseSize * 1.75}px`;
        el.style.fontFamily = fontStack;
      });
      
      const welcomeElements = document.querySelectorAll('.welcome-text');
      welcomeElements.forEach(el => {
        el.textContent = appConfig.welcome_text;
        el.style.color = appConfig.text_color;
        el.style.fontSize = `${baseSize * 1.125}px`;
        el.style.fontFamily = fontStack;
      });
      
      const instructionElements = document.querySelectorAll('.instruction-text');
      instructionElements.forEach(el => {
        el.textContent = appConfig.instruction_text;
        el.style.color = appConfig.text_color;
        el.style.fontSize = `${baseSize}px`;
        el.style.fontFamily = fontStack;
      });
      
      const honestyElements = document.querySelectorAll('.honesty-statement');
      honestyElements.forEach(el => {
        el.textContent = appConfig.honesty_statement;
        el.style.color = appConfig.text_color;
        el.style.fontSize = `${baseSize}px`;
        el.style.fontFamily = fontStack;
      });
      
      const cards = document.querySelectorAll('.card-bg');
      cards.forEach(el => {
        el.style.backgroundColor = appConfig.card_color;
      });
      
      const primaryButtons = document.querySelectorAll('.btn-primary');
      primaryButtons.forEach(el => {
        el.style.backgroundColor = appConfig.primary_color;
        el.style.fontSize = `${baseSize}px`;
        el.style.fontFamily = fontStack;
      });
      
      const textElements = document.querySelectorAll('.text-content');
      textElements.forEach(el => {
        el.style.color = appConfig.text_color;
        el.style.fontSize = `${baseSize}px`;
        el.style.fontFamily = fontStack;
      });
      
      const successElements = document.querySelectorAll('.success-color');
      successElements.forEach(el => {
        el.style.color = appConfig.success_color;
      });
    }

    async function init() {
      setupSecurityMeasures();
      
      await loadConfigFromFirebase();
      await loadQuestionsFromFirebase();
      
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (config) => {
            appConfig = {...appConfig, ...config};
            applyConfig();
          },
          mapToCapabilities: (config) => ({
            recolorables: [
              {
                get: () => appConfig.background_color,
                set: (value) => {
                  appConfig.background_color = value;
                  window.elementSdk.setConfig({ background_color: value });
                }
              },
              {
                get: () => appConfig.card_color,
                set: (value) => {
                  appConfig.card_color = value;
                  window.elementSdk.setConfig({ card_color: value });
                }
              },
              {
                get: () => appConfig.primary_color,
                set: (value) => {
                  appConfig.primary_color = value;
                  window.elementSdk.setConfig({ primary_color: value });
                }
              },
              {
                get: () => appConfig.text_color,
                set: (value) => {
                  appConfig.text_color = value;
                  window.elementSdk.setConfig({ text_color: value });
                }
              },
              {
                get: () => appConfig.success_color,
                set: (value) => {
                  appConfig.success_color = value;
                  window.elementSdk.setConfig({ success_color: value });
                }
              }
            ],
            borderables: [],
            fontEditable: {
              get: () => appConfig.font_family,
              set: (value) => {
                appConfig.font_family = value;
                window.elementSdk.setConfig({ font_family: value });
              }
            },
            fontSizeable: {
              get: () => appConfig.font_size,
              set: (value) => {
                appConfig.font_size = value;
                window.elementSdk.setConfig({ font_size: value });
              }
            }
          }),
          mapToEditPanelValues: (config) => new Map([
            ["app_title", appConfig.app_title],
            ["welcome_text", appConfig.welcome_text],
            ["instruction_text", appConfig.instruction_text],
            ["honesty_statement", appConfig.honesty_statement]
          ])
        });
      }

      renderLoginScreen();
    }

    function renderLoginScreen() {
      isExamMode = false;
      stopTimer();
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="w-full h-full flex items-center justify-center p-6 overflow-auto">
          <div class="card-bg glass-effect w-full max-w-md rounded-2xl shadow-2xl p-8 fade-in">
            <div class="flex justify-center mb-6">
              <img src="https://spenzaga.github.io/assets/img/logo.png" alt="Logo" class="h-24 shimmer" onerror="this.style.display='none'; this.alt='Logo failed to load';">
            </div>
            
            <h1 class="app-title text-center font-bold mb-2"></h1>
            <p class="welcome-text text-center mb-8"></p>
            
            <form id="loginForm" class="space-y-5">
              <div>
                <label class="text-content block mb-2 font-semibold flex items-center gap-2">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
                  </svg>
                  NIS (Nomor Induk Siswa)
                </label>
                <input 
                  type="text" 
                  id="nisInput" 
                  required
                  class="w-full px-4 py-3 border-2 rounded-xl focus:outline-none focus:ring-2 focus:ring-offset-2 transition-all"
                  placeholder="Masukkan NIS Anda"
                />
              </div>
              
              <div id="loginError" class="hidden p-4 bg-red-100 text-red-700 rounded-xl text-sm font-semibold flex items-center gap-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                </svg>
                <span id="loginErrorText"></span>
              </div>
              
              <button 
                type="submit" 
                id="loginButton"
                class="btn-primary btn-gradient w-full text-white py-4 rounded-xl font-bold transition flex items-center justify-center gap-2"
              >
                <span id="loginButtonText">Masuk ke Ujian</span>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
                </svg>
              </button>
            </form>
            
            <div class="mt-6 p-4 bg-blue-50 rounded-xl border border-blue-200">
              <p class="text-sm text-blue-800 text-center font-medium">
                üí° Pastikan koneksi internet Anda stabil
              </p>
            </div>
          </div>
        </div>
      `;
      
      applyConfig();
      
      document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const nis = document.getElementById('nisInput').value.trim();
        const loginButton = document.getElementById('loginButton');
        const loginButtonText = document.getElementById('loginButtonText');
        const loginError = document.getElementById('loginError');
        const loginErrorText = document.getElementById('loginErrorText');
        
        loginError.classList.add('hidden');
        loginButton.disabled = true;
        loginButtonText.innerHTML = '<div class="loading-spinner"></div>';
        
        try {
          const snapshot = await database.ref('students').orderByChild('nis').equalTo(nis).once('value');
          
          if (snapshot.exists()) {
            const studentData = Object.values(snapshot.val())[0];
            currentStudent = studentData;
            
            const scoreSnapshot = await database.ref('scores').orderByChild('student_id').equalTo(currentStudent.student_id).once('value');
            
            if (scoreSnapshot.exists()) {
              existingScore = Object.values(scoreSnapshot.val())[0];
              showToast('Data ditemukan! Menampilkan hasil ujian...', 'success');
              setTimeout(() => renderScorePage(), 500);
            } else {
              if (questionsData.length === 0) {
                loginErrorText.textContent = 'Tidak ada soal tersedia. Hubungi administrator.';
                loginError.classList.remove('hidden');
                loginButton.disabled = false;
                loginButtonText.textContent = 'Masuk ke Ujian';
              } else {
                showToast('Selamat datang, ' + currentStudent.name + '!', 'success');
                setTimeout(() => renderConfirmation(), 500);
              }
            }
          } else {
            loginErrorText.textContent = 'NIS tidak ditemukan. Silakan periksa kembali NIS Anda.';
            loginError.classList.remove('hidden');
            loginButton.disabled = false;
            loginButtonText.textContent = 'Masuk ke Ujian';
          }
        } catch (error) {
          loginErrorText.textContent = 'Terjadi kesalahan saat login. Silakan coba lagi.';
          loginError.classList.remove('hidden');
          loginButton.disabled = false;
          loginButtonText.textContent = 'Masuk ke Ujian';
        }
      });
    }

    function renderConfirmation() {
      isExamMode = false;
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="w-full h-full flex items-center justify-center p-6 overflow-auto">
          <div class="card-bg glass-effect w-full max-w-2xl rounded-2xl shadow-2xl p-8 fade-in">
            <div class="flex justify-center mb-6">
              <img src="https://spenzaga.github.io/assets/img/logo.png" alt="Logo" class="h-20 shimmer" onerror="this.style.display='none'; this.alt='Logo failed to load';">
            </div>
            
            <h2 class="app-title text-center font-bold mb-8">Konfirmasi Data Siswa</h2>
            
            <div class="card-bg rounded-xl p-6 mb-6 space-y-4 border-2 border-blue-100">
              <div class="flex justify-between items-center pb-4 border-b-2 border-gray-100">
                <span class="text-content font-semibold text-gray-600 flex items-center gap-2">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"/>
                  </svg>
                  No. Absen
                </span>
                <span class="text-content font-bold text-xl">${currentStudent.absen}</span>
              </div>
              
              <div class="flex justify-between items-center pb-4 border-b-2 border-gray-100">
                <span class="text-content font-semibold text-gray-600 flex items-center gap-2">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0a2 2 0 104 0m-5 8a2 2 0 100-4 2 2 0 000 4zm0 0c1.306 0 2.417.835 2.83 2M9 14a3.001 3.001 0 00-2.83 2M15 11h3m-3 4h2"/>
                  </svg>
                  NIS
                </span>
                <span class="text-content font-bold text-xl">${currentStudent.nis}</span>
              </div>
              
              <div class="flex justify-between items-center pb-4 border-b-2 border-gray-100">
                <span class="text-content font-semibold text-gray-600 flex items-center gap-2">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                  </svg>
                  Nama Lengkap
                </span>
                <span class="text-content font-bold text-xl">${currentStudent.name}</span>
              </div>
              
              <div class="flex justify-between items-center">
                <span class="text-content font-semibold text-gray-600 flex items-center gap-2">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                  </svg>
                  Kelas
                </span>
                <span class="text-content font-bold text-xl">${currentStudent.class}</span>
              </div>
            </div>
            
            <div class="card-bg rounded-xl p-6 mb-6 border-2 border-yellow-100 bg-yellow-50">
              <h3 class="text-content font-bold mb-4 flex items-center gap-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                Pernyataan Kejujuran
              </h3>
              <label class="flex items-start cursor-pointer group">
                <input 
                  type="checkbox" 
                  id="honestyCheck"
                  class="mt-1 mr-4 w-6 h-6 cursor-pointer"
                />
                <span class="honesty-statement text-content group-hover:text-gray-700 transition"></span>
              </label>
            </div>
            
            <div class="p-5 bg-gradient-to-r from-red-100 to-orange-100 rounded-xl mb-6 border-2 border-red-200">
              <div class="flex items-start gap-3">
                <svg class="w-6 h-6 text-red-600 flex-shrink-0 mt-1" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                </svg>
                <div>
                  <p class="text-content text-sm font-bold text-red-800 mb-2">
                    ‚ö†Ô∏è PERHATIAN PENTING - Sistem Keamanan Aktif:
                  </p>
                  <ul class="text-content text-sm text-red-700 space-y-1">
                    <li>‚Ä¢ Screenshot akan terdeteksi dan tercatat</li>
                    <li>‚Ä¢ Membuka tab/window baru akan diblokir</li>
                    <li>‚Ä¢ Google Translate akan otomatis dinonaktifkan</li>
                    <li>‚Ä¢ Meninggalkan halaman akan tercatat sebagai pelanggaran</li>
                  </ul>
                </div>
              </div>
            </div>
            
            <div class="flex gap-4">
              <button 
                onclick="renderLoginScreen()" 
                class="text-content px-8 py-4 border-2 rounded-xl font-bold hover:bg-gray-50 transition-all flex items-center gap-2"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                </svg>
                Batal
              </button>
              
              <button 
                id="confirmButton"
                onclick="confirmAndStart()" 
                class="btn-primary btn-gradient flex-1 text-white py-4 rounded-xl font-bold transition-all flex items-center justify-center gap-2"
                disabled
              >
                Mulai Ujian
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
      `;
      
      applyConfig();
      
      document.getElementById('honestyCheck').addEventListener('change', (e) => {
        const confirmButton = document.getElementById('confirmButton');
        confirmButton.disabled = !e.target.checked;
        if (e.target.checked) {
          confirmButton.classList.add('pulse-animation');
        } else {
          confirmButton.classList.remove('pulse-animation');
        }
      });
    }

    function confirmAndStart() {
      isExamMode = true;
      currentQuestionIndex = 0;
      userAnswers = {};
      examStartTime = new Date();
      securityWarnings = 0;
      startTimer();
      showToast('Ujian dimulai! Semangat! üí™', 'success');
      renderQuestion();
    }

    function renderQuestion() {
      const question = questionsData[currentQuestionIndex];
      const app = document.getElementById('app');
      
      app.innerHTML = `
        <button 
          onclick="toggleNavigation()" 
          class="toggle-nav-btn btn-primary btn-gradient text-white px-4 py-3 rounded-l-xl hover:opacity-90 transition"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
          </svg>
        </button>
        
        <div class="floating-nav card-bg glass-effect rounded-l-2xl hidden-nav" style="width: 300px;">
          <div class="p-5">
            <h3 class="text-content font-bold mb-4 text-center flex items-center justify-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
              </svg>
              Navigasi Soal
            </h3>
            <div id="navigationGrid" class="nav-grid mb-5"></div>
            <div class="space-y-3 text-sm">
              <div class="flex items-center gap-3">
                <div class="w-7 h-7 rounded-lg" style="background-color: #10b981;"></div>
                <span class="text-content font-medium">Sudah Dijawab</span>
              </div>
              <div class="flex items-center gap-3">
                <div class="w-7 h-7 rounded-lg border-2" style="border-color: #e2e8f0;"></div>
                <span class="text-content font-medium">Belum Dijawab</span>
              </div>
              <div class="flex items-center gap-3">
                <div class="w-7 h-7 rounded-lg border-3" style="border-color: #2563eb;"></div>
                <span class="text-content font-medium">Soal Aktif</span>
              </div>
            </div>
          </div>
        </div>
        
        <div class="w-full h-full overflow-auto">
          <div class="sticky top-0 z-50 card-bg glass-effect shadow-lg border-b-2 border-gray-100">
            <div class="max-w-6xl mx-auto px-6 py-4 flex justify-between items-center">
              <div class="flex items-center gap-4">
                <img src="https://spenzaga.github.io/assets/img/logo.png" alt="Logo" class="h-12" onerror="this.style.display='none'; this.alt='Logo failed to load';">
                <div>
                  <h2 class="text-content font-bold text-lg">${currentStudent.name}</h2>
                  <p class="text-content text-sm text-gray-600">${currentStudent.class} - NIS: ${currentStudent.nis}</p>
                </div>
              </div>
              
              <div class="timer-display shimmer">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span id="examTimer">00:00:00</span>
              </div>
            </div>
          </div>
          
          <div class="max-w-5xl mx-auto p-6">
            <div class="card-bg glass-effect rounded-2xl shadow-2xl p-8 mb-6 question-card">
              <div class="flex justify-between items-center mb-6 pb-4 border-b-2 border-gray-100">
                <div class="flex items-center gap-3">
                  <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white w-12 h-12 rounded-xl flex items-center justify-center font-bold text-lg shadow-lg">
                    ${currentQuestionIndex + 1}
                  </div>
                  <div>
                    <span class="text-content font-bold text-lg">Soal ${currentQuestionIndex + 1} dari ${questionsData.length}</span>
                    <div class="flex items-center gap-2 mt-1">
                      <svg class="w-4 h-4 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                      </svg>
                      <span class="text-content font-semibold text-yellow-600">${question.points} Poin</span>
                    </div>
                  </div>
                </div>
                
                <div class="text-right">
                  <div class="text-content text-sm font-semibold text-gray-600 mb-1">Progress</div>
                  <div class="text-content text-2xl font-bold">${Math.round(((currentQuestionIndex + 1) / questionsData.length) * 100)}%</div>
                </div>
              </div>
              
              <div class="w-full bg-gray-200 rounded-full h-4 mb-8 overflow-hidden shadow-inner">
                <div class="btn-primary btn-gradient h-4 rounded-full transition-all duration-700 shimmer relative" style="width: ${((currentQuestionIndex + 1) / questionsData.length) * 100}%">
                  <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white to-transparent opacity-30 animate-shimmer"></div>
                </div>
              </div>
              
              <div class="mb-8">
                ${question.question_paragraph ? `
                  <div class="text-content mb-6 p-5 card-bg rounded-xl border-l-4 border-blue-500 shadow-sm">
                    ${question.question_paragraph}
                  </div>
                ` : ''}
                
                ${question.audio ? `
                  <div class="mb-6 p-5 bg-gradient-to-r from-purple-100 to-pink-100 rounded-xl border-2 border-purple-200">
                    <div class="flex items-center gap-3 mb-3">
                      <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/>
                      </svg>
                      <span class="text-content font-bold text-purple-800">Audio Soal</span>
                    </div>
                    <audio controls class="w-full">
                      <source src="${question.audio}" type="audio/mpeg">
                    </audio>
                  </div>
                ` : ''}
                
                ${question.image ? `
                  <div class="mb-6">
                    <img src="${question.image}" alt="Question image" class="max-w-full h-auto rounded-xl shadow-lg border-2 border-gray-100" onerror="this.style.display='none'; this.alt='Image failed to load';">
                  </div>
                ` : ''}
                
                <h3 class="text-content text-2xl font-bold mb-6 leading-relaxed">${question.question_text}</h3>
              </div>
              
              <div id="answersContainer" class="space-y-4 mb-8"></div>
              
              <div id="feedbackContainer" class="mb-6"></div>
              
              <div class="flex gap-4 pt-6 border-t-2 border-gray-100">
                ${currentQuestionIndex > 0 ? `
                  <button 
                    onclick="previousQuestion()" 
                    class="text-content px-8 py-4 border-2 rounded-xl font-bold hover:bg-gray-50 transition-all flex items-center gap-2"
                  >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                    Sebelumnya
                  </button>
                ` : ''}
                
                ${currentQuestionIndex < questionsData.length - 1 ? `
                  <button 
                    onclick="nextQuestion()" 
                    class="btn-primary btn-gradient flex-1 px-8 py-4 text-white rounded-xl font-bold transition-all flex items-center justify-center gap-2"
                  >
                    Berikutnya
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                  </button>
                ` : `
                  <button 
                    onclick="finishExam()" 
                    class="btn-success flex-1 px-8 py-4 text-white rounded-xl font-bold transition-all flex items-center justify-center gap-2 pulse-animation"
                  >
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    Selesai Ujian
                  </button>
                `}
              </div>
            </div>
          </div>
        </div>
      `;
      
      applyConfig();
      renderAnswerOptions(question);
      updateNavigation();
    }

    function updateNavigation() {
      const grid = document.getElementById('navigationGrid');
      if (!grid) return;
      
      grid.innerHTML = '';
      
      questionsData.forEach((q, index) => {
        const isAnswered = userAnswers[q.question_id] !== undefined && 
                          userAnswers[q.question_id] !== null && 
                          userAnswers[q.question_id] !== '' &&
                          !(Array.isArray(userAnswers[q.question_id]) && userAnswers[q.question_id].length === 0) &&
                          !(typeof userAnswers[q.question_id] === 'object' && Object.keys(userAnswers[q.question_id]).length === 0);
        
        const navItem = document.createElement('div');
        navItem.className = `nav-item ${isAnswered ? 'answered' : ''} ${index === currentQuestionIndex ? 'current' : ''}`;
        navItem.textContent = index + 1;
        navItem.style.backgroundColor = isAnswered ? '#10b981' : '#e2e8f0';
        navItem.style.color = isAnswered ? 'white' : '#1e293b';
        
        if (index === currentQuestionIndex) {
          navItem.style.borderColor = appConfig.primary_color;
        }
        
        navItem.addEventListener('click', () => {
          currentQuestionIndex = index;
          renderQuestion();
        });
        
        grid.appendChild(navItem);
      });
    }

    function toggleNavigation() {
      showNav = !showNav;
      const nav = document.querySelector('.floating-nav');
      if (showNav) {
        nav.classList.remove('hidden-nav');
      } else {
        nav.classList.add('hidden-nav');
      }
    }

    function renderAnswerOptions(question) {
      const container = document.getElementById('answersContainer');
      const answers = [question.answer_1, question.answer_2, question.answer_3, question.answer_4].filter(a => a);
      
      if (question.question_type === 'TF' || question.question_type === 'MC') {
        answers.forEach((answer, index) => {
          const cleanAnswer = answer.replace('*', '');
          const isSelected = userAnswers[question.question_id] === cleanAnswer;
          
          const option = document.createElement('div');
          option.className = `answer-option card-bg glass-effect p-5 rounded-xl border-2 ${isSelected ? 'selected' : ''}`;
          option.style.borderColor = isSelected ? appConfig.primary_color : '#e2e8f0';
          option.innerHTML = `
            <label class="flex items-center cursor-pointer">
              <input 
                type="radio" 
                name="answer" 
                value="${cleanAnswer}"
                ${isSelected ? 'checked' : ''}
                class="mr-4 w-5 h-5 cursor-pointer"
              />
              <span class="text-content font-medium text-lg">${cleanAnswer}</span>
            </label>
          `;
          
          option.addEventListener('click', () => {
            document.querySelectorAll('.answer-option').forEach(opt => {
              opt.classList.remove('selected');
              opt.style.borderColor = '#e2e8f0';
            });
            option.classList.add('selected');
            option.style.borderColor = appConfig.primary_color;
            option.querySelector('input').checked = true;
            userAnswers[question.question_id] = cleanAnswer;
            updateNavigation();
            showToast('Jawaban tersimpan ‚úì', 'success');
          });
          
          container.appendChild(option);
        });
      } else if (question.question_type === 'MR') {
        const selectedAnswers = userAnswers[question.question_id] || [];
        
        answers.forEach((answer, index) => {
          const cleanAnswer = answer.replace('*', '');
          const isSelected = selectedAnswers.includes(cleanAnswer);
          
          const option = document.createElement('div');
          option.className = `answer-option card-bg glass-effect p-5 rounded-xl border-2 ${isSelected ? 'selected' : ''}`;
          option.style.borderColor = isSelected ? appConfig.primary_color : '#e2e8f0';
          option.innerHTML = `
            <label class="flex items-center cursor-pointer">
              <input 
                type="checkbox" 
                value="${cleanAnswer}"
                ${isSelected ? 'checked' : ''}
                class="mr-4 w-5 h-5 cursor-pointer"
              />
              <span class="text-content font-medium text-lg">${cleanAnswer}</span>
            </label>
          `;
          
          option.addEventListener('click', (e) => {
            if (e.target.tagName !== 'INPUT') {
              const checkbox = option.querySelector('input');
              checkbox.checked = !checkbox.checked;
            }
            
            const checkbox = option.querySelector('input');
            if (checkbox.checked) {
              option.classList.add('selected');
              option.style.borderColor = appConfig.primary_color;
              if (!selectedAnswers.includes(cleanAnswer)) {
                selectedAnswers.push(cleanAnswer);
              }
              showToast('Jawaban ditambahkan ‚úì', 'success');
            } else {
              option.classList.remove('selected');
              option.style.borderColor = '#e2e8f0';
              const idx = selectedAnswers.indexOf(cleanAnswer);
              if (idx > -1) {
                selectedAnswers.splice(idx, 1);
              }
              showToast('Jawaban dihapus', 'info');
            }
            
            userAnswers[question.question_id] = selectedAnswers.length > 0 ? selectedAnswers : [];
            updateNavigation();
          });
          
          container.appendChild(option);
        });
      } else if (question.question_type === 'TI') {
        const currentAnswer = userAnswers[question.question_id] || '';
        
        const input = document.createElement('div');
        input.className = 'card-bg glass-effect p-5 rounded-xl border-2';
        input.innerHTML = `
          <input 
            type="text" 
            id="textAnswer"
            value="${currentAnswer}"
            placeholder="Ketik jawaban Anda di sini..."
            class="w-full px-5 py-4 border-2 rounded-xl focus:outline-none focus:ring-2 text-content text-lg"
          />
        `;
        
        const inputElement = input.querySelector('input');
        inputElement.addEventListener('input', (e) => {
          userAnswers[question.question_id] = e.target.value;
          updateNavigation();
        });
        
        inputElement.addEventListener('blur', () => {
          if (inputElement.value) {
            showToast('Jawaban tersimpan ‚úì', 'success');
          }
        });
        
        container.appendChild(input);
      } else if (question.question_type === 'NUMG') {
        const currentAnswer = userAnswers[question.question_id] || '';
        
        const input = document.createElement('div');
        input.className = 'card-bg glass-effect p-5 rounded-xl border-2';
        input.innerHTML = `
          <input 
            type="number" 
            id="numericAnswer"
            value="${currentAnswer}"
            placeholder="Masukkan angka jawaban..."
            class="w-full px-5 py-4 border-2 rounded-xl focus:outline-none focus:ring-2 text-content text-lg"
          />
        `;
        
        const inputElement = input.querySelector('input');
        inputElement.addEventListener('input', (e) => {
          userAnswers[question.question_id] = e.target.value;
          updateNavigation();
        });
        
        inputElement.addEventListener('blur', () => {
          if (inputElement.value) {
            showToast('Jawaban tersimpan ‚úì', 'success');
          }
        });
        
        container.appendChild(input);
      } else if (question.question_type === 'MG') {
        const pairs = answers.map(a => {
          const [left, right] = a.split('|');
          return { left: left.replace('*', ''), right: right.replace('*', '') };
        });
        
        const leftItems = pairs.map(p => p.left);
        const rightItems = pairs.map(p => p.right).sort(() => Math.random() - 0.5);
        
        const savedMatches = userAnswers[question.question_id] || {};
        
        container.innerHTML = `
          <div class="mb-6 text-content p-5 bg-blue-50 rounded-xl border-2 border-blue-200">
            <p class="font-bold text-blue-800 flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              Klik item di kolom kiri, lalu klik pasangannya di kolom kanan
            </p>
          </div>
          <div class="match-container">
            <div id="leftColumn" class="space-y-3"></div>
            <div id="rightColumn" class="space-y-3"></div>
          </div>
        `;
        
        let selectedLeft = null;
        
        const leftColumn = document.getElementById('leftColumn');
        const rightColumn = document.getElementById('rightColumn');
        
        leftItems.forEach((item, index) => {
          const leftItem = document.createElement('div');
          leftItem.className = 'match-item glass-effect';
          leftItem.dataset.value = item;
          leftItem.innerHTML = `<span class="text-content font-medium">${item}</span>`;
          
          if (savedMatches[item]) {
            leftItem.classList.add('matched');
            leftItem.innerHTML += `<div class="text-sm text-green-700 mt-2 font-semibold">‚Üí ${savedMatches[item]}</div>`;
          }
          
          leftItem.addEventListener('click', () => {
            if (leftItem.classList.contains('matched')) return;
            
            document.querySelectorAll('#leftColumn .match-item').forEach(el => {
              el.classList.remove('selected');
            });
            leftItem.classList.add('selected');
            selectedLeft = item;
            showToast('Pilih pasangan di kolom kanan', 'info');
          });
          
          leftColumn.appendChild(leftItem);
        });
        
        rightItems.forEach((item, index) => {
          const rightItem = document.createElement('div');
          rightItem.className = 'match-item glass-effect';
          rightItem.dataset.value = item;
          rightItem.innerHTML = `<span class="text-content font-medium">${item}</span>`;
          
          const isMatched = Object.values(savedMatches).includes(item);
          if (isMatched) {
            rightItem.classList.add('matched');
          }
          
          rightItem.addEventListener('click', () => {
            if (rightItem.classList.contains('matched')) return;
            if (!selectedLeft) {
              showToast('Pilih item di kolom kiri terlebih dahulu', 'warning');
              return;
            }
            
            savedMatches[selectedLeft] = item;
            userAnswers[question.question_id] = savedMatches;
            updateNavigation();
            
            const leftItem = document.querySelector(`#leftColumn .match-item[data-value="${selectedLeft}"]`);
            leftItem.classList.remove('selected');
            leftItem.classList.add('matched');
            leftItem.innerHTML = `<span class="text-content font-medium">${selectedLeft}</span><div class="text-sm text-green-700 mt-2 font-semibold">‚Üí ${item}</div>`;
            
            rightItem.classList.add('matched');
            
            selectedLeft = null;
            showToast('Pasangan berhasil! ‚úì', 'success');
          });
          
          rightColumn.appendChild(rightItem);
        });
      } else if (question.question_type === 'SEQ') {
        const items = answers.map(a => a.replace('*', ''));
        const savedOrder = userAnswers[question.question_id] || items.slice().sort(() => Math.random() - 0.5);
        
        container.innerHTML = `
          <div class="mb-6 text-content p-5 bg-purple-50 rounded-xl border-2 border-purple-200">
            <p class="font-bold text-purple-800 flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"/>
              </svg>
              Seret dan lepas item untuk mengurutkan
            </p>
          </div>
          <div id="sequenceContainer" class="space-y-3"></div>
        `;
        
        const seqContainer = document.getElementById('sequenceContainer');
        
        savedOrder.forEach((item, index) => {
          const seqItem = document.createElement('div');
          seqItem.className = 'answer-option card-bg glass-effect p-5 rounded-xl border-2 cursor-move';
          seqItem.draggable = true;
          seqItem.dataset.value = item;
          seqItem.innerHTML = `
            <div class="flex items-center gap-4">
              <div class="bg-gradient-to-r from-purple-500 to-pink-500 text-white w-10 h-10 rounded-xl flex items-center justify-center font-bold shadow-lg">
                ${index + 1}
              </div>
              <span class="text-content font-medium text-lg flex-1">${item}</span>
              <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"/>
              </svg>
            </div>
          `;
          
          seqItem.addEventListener('dragstart', (e) => {
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', seqItem.innerHTML);
            seqItem.classList.add('dragging');
          });
          
          seqItem.addEventListener('dragend', (e) => {
            seqItem.classList.remove('dragging');
          });
          
          seqItem.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            seqItem.classList.add('drag-over');
          });
          
          seqItem.addEventListener('dragleave', (e) => {
            seqItem.classList.remove('drag-over');
          });
          
          seqItem.addEventListener('drop', (e) => {
            e.preventDefault();
            seqItem.classList.remove('drag-over');
            
            const dragging = document.querySelector('.dragging');
            if (dragging && dragging !== seqItem) {
              const allItems = [...seqContainer.children];
              const dragIndex = allItems.indexOf(dragging);
              const dropIndex = allItems.indexOf(seqItem);
              
              if (dragIndex < dropIndex) {
                seqItem.after(dragging);
              } else {
                seqItem.before(dragging);
              }
              
              updateSequenceNumbers();
              showToast('Urutan diubah', 'info');
            }
          });
          
          seqContainer.appendChild(seqItem);
        });
        
        function updateSequenceNumbers() {
          const items = [...seqContainer.children];
          const newOrder = items.map(item => item.dataset.value);
          userAnswers[question.question_id] = newOrder;
          updateNavigation();
          
          items.forEach((item, index) => {
            const numberDiv = item.querySelector('.bg-gradient-to-r');
            numberDiv.textContent = index + 1;
          });
        }
      }
    }

    function previousQuestion() {
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        renderQuestion();
      }
    }

    function nextQuestion() {
      if (currentQuestionIndex < questionsData.length - 1) {
        currentQuestionIndex++;
        renderQuestion();
      }
    }

    async function finishExam() {
      const unansweredCount = questionsData.filter(q => {
        const answer = userAnswers[q.question_id];
        return answer === undefined || 
               answer === null || 
               answer === '' ||
               (Array.isArray(answer) && answer.length === 0) ||
               (typeof answer === 'object' && Object.keys(answer).length === 0);
      }).length;
      
      if (unansweredCount > 0) {
        const confirmDiv = document.createElement('div');
        confirmDiv.className = 'warning-overlay';
        confirmDiv.innerHTML = `
          <div class="card-bg glass-effect rounded-2xl p-8 max-w-md fade-in">
            <div class="text-center mb-6">
              <svg class="w-20 h-20 text-yellow-500 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
              </svg>
            </div>
            <h3 class="text-content text-2xl font-bold text-center mb-4">Peringatan!</h3>
            <p class="text-content text-center mb-6">
              Anda masih memiliki <strong class="text-red-600 text-xl">${unansweredCount} soal</strong> yang belum dijawab.
              <br><br>
              Apakah Anda yakin ingin menyelesaikan ujian?
            </p>
            <div class="flex gap-4">
              <button 
                onclick="this.parentElement.parentElement.parentElement.remove()" 
                class="flex-1 px-6 py-4 border-2 rounded-xl font-bold hover:bg-gray-50 transition text-content"
              >
                Cek Lagi
              </button>
              <button 
                onclick="submitExam(); this.parentElement.parentElement.parentElement.remove();" 
                class="flex-1 px-6 py-4 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-xl font-bold hover:opacity-90 transition"
              >
                Ya, Selesaikan
              </button>
            </div>
          </div>
        `;
        document.body.appendChild(confirmDiv);
      } else {
        submitExam();
      }
    }

    async function submitExam() {
      isExamMode = false;
      stopTimer();
      
      const endTime = new Date();
      const duration = Math.floor((endTime - examStartTime) / 1000);
      const hours = Math.floor(duration / 3600);
      const minutes = Math.floor((duration % 3600) / 60);
      const seconds = duration % 60;
      const durationStr = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
      
      const answersArray = [];
      let totalScore = 0;
      
      questionsData.forEach(question => {
        const userAnswer = userAnswers[question.question_id];
        const answers = [question.answer_1, question.answer_2, question.answer_3, question.answer_4].filter(a => a);
        const correctAnswers = answers.filter(a => a.startsWith('*')).map(a => a.substring(1));
        
        let isCorrect = false;
        let response = userAnswer;
        
        if (question.question_type === 'TI') {
          isCorrect = correctAnswers.some(correct => 
            correct.toLowerCase() === String(userAnswer).toLowerCase()
          );
        } else if (question.question_type === 'NUMG') {
          isCorrect = correctAnswers.some(correct => 
            parseFloat(correct) === parseFloat(userAnswer)
          );
          response = String(userAnswer);
        } else if (question.question_type === 'MR') {
          const userAnswerSet = new Set(userAnswer || []);
          const correctAnswerSet = new Set(correctAnswers);
          isCorrect = userAnswerSet.size === correctAnswerSet.size && 
                     [...userAnswerSet].every(ans => correctAnswerSet.has(ans));
        } else if (question.question_type === 'MG') {
          const correctPairs = {};
          answers.forEach(a => {
            const [left, right] = a.split('|');
            correctPairs[left.replace('*', '')] = right.replace('*', '');
          });
          
          isCorrect = Object.keys(correctPairs).every(key => 
            userAnswer && userAnswer[key] === correctPairs[key]
          );
          
          response = [];
          if (userAnswer) {
            Object.keys(userAnswer).forEach(key => {
              response.push(`${key}|${userAnswer[key]}`);
            });
          }
        } else if (question.question_type === 'SEQ') {
          const correctOrder = answers.map(a => a.replace('*', ''));
          isCorrect = JSON.stringify(userAnswer) === JSON.stringify(correctOrder);
        } else {
          isCorrect = correctAnswers.includes(userAnswer);
        }
        
        const pointsAwarded = isCorrect ? parseInt(question.points) : 0;
        totalScore += pointsAwarded;
        
        answersArray.push({
          question_id: question.question_id,
          response: response,
          correct: isCorrect,
          points_awarded: String(pointsAwarded)
        });
      });
      
      const percentage = (totalScore / (questionsData.length * 10)) * 100;
      const status = percentage >= 60 ? "Lulus" : "Tidak Lulus";
      
      const scoreData = {
        student_id: currentStudent.student_id,
        answers: answersArray,
        total_score: String(totalScore),
        duration: durationStr,
        status: status
      };
      
      try {
        await database.ref('scores').push(scoreData);
        existingScore = scoreData;
        showToast('Ujian berhasil diselesaikan! üéâ', 'success');
        setTimeout(() => renderScorePage(), 1000);
      } catch (error) {
        showToast('Terjadi kesalahan saat menyimpan hasil', 'error');
      }
    }

    function renderScorePage() {
      isExamMode = false;
      stopTimer();
      
      const totalQuestions = questionsData.length;
      const correctAnswers = existingScore.answers.filter(a => a.correct).length;
      const totalScore = parseInt(existingScore.total_score);
      const maxScore = totalQuestions * 10;
      const percentage = Math.round((totalScore / maxScore) * 100);
      
      let badgeClass = 'badge-fail';
      let badgeLabel = 'Perlu Belajar Lagi';
      if (percentage >= 90) {
        badgeClass = 'badge-excellent';
        badgeLabel = 'Luar Biasa!';
      } else if (percentage >= 80) {
        badgeClass = 'badge-good';
        badgeLabel = 'Sangat Baik!';
      } else if (percentage >= 60) {
        badgeClass = 'badge-pass';
        badgeLabel = 'Baik';
      }
      
      if (percentage >= 80) {
        setTimeout(() => {
          const duration = 4000;
          const end = Date.now() + duration;
          
          (function frame() {
            confetti({
              particleCount: 5,
              angle: 60,
              spread: 70,
              origin: { x: 0, y: 0.8 },
              colors: ['#2563eb', '#16a34a', '#eab308', '#dc2626', '#9333ea', '#ec4899']
            });
            confetti({
              particleCount: 5,
              angle: 120,
              spread: 70,
              origin: { x: 1, y: 0.8 },
              colors: ['#2563eb', '#16a34a', '#eab308', '#dc2626', '#9333ea', '#ec4899']
            });
            
            if (Date.now() < end) {
              requestAnimationFrame(frame);
            }
          }());
        }, 500);
      }
      
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="w-full h-full p-6 overflow-auto">
          <div class="max-w-4xl mx-auto">
            <div class="card-bg glass-effect rounded-2xl shadow-2xl p-8 fade-in">
              <div class="flex justify-center mb-6">
                <img src="https://spenzaga.github.io/assets/img/logo.png" alt="Logo" class="h-20 shimmer" onerror="this.style.display='none'; this.alt='Logo failed to load';">
              </div>
              
              <h2 class="app-title text-center font-bold mb-3">Hasil Ujian</h2>
              <p class="text-content text-center text-gray-600 mb-8">${badgeLabel}</p>
              
              <div class="flex justify-center mb-8">
                <div class="score-badge ${badgeClass}">
                  ${percentage}%
                </div>
              </div>
              
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <div class="stat-card">
                  <svg class="w-8 h-8 mx-auto mb-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                  </svg>
                  <div class="text-content font-bold text-2xl text-blue-600">${correctAnswers}</div>
                  <div class="text-content text-sm text-gray-600">Jawaban Benar</div>
                </div>
                
                <div class="stat-card">
                  <svg class="w-8 h-8 mx-auto mb-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                  </svg>
                  <div class="text-content font-bold text-2xl text-purple-600">${existingScore.duration}</div>
                  <div class="text-content text-sm text-gray-600">Durasi</div>
                </div>
                
                <div class="stat-card">
                  <svg class="w-8 h-8 mx-auto mb-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                  </svg>
                  <div class="text-content font-bold text-2xl text-green-600">${totalScore}</div>
                  <div class="text-content text-sm text-gray-600">Skor Total</div>
                </div>
              </div>
              
              <div class="card-bg rounded-xl p-6 mb-8 space-y-4 border-2 border-gray-100">
                <h3 class="text-content font-bold text-xl mb-4 flex items-center gap-2">
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                  </svg>
                  Detail Siswa
                </h3>
                
                <div class="grid grid-cols-2 gap-4">
                  <div class="flex justify-between items-center pb-3 border-b-2">
                    <span class="text-content font-semibold text-gray-600">Absen:</span>
                    <span class="text-content font-bold">${currentStudent.absen}</span>
                  </div>
                  
                  <div class="flex justify-between items-center pb-3 border-b-2">
                    <span class="text-content font-semibold text-gray-600">NIS:</span>
                    <span class="text-content font-bold">${currentStudent.nis}</span>
                  </div>
                  
                  <div class="flex justify-between items-center pb-3 border-b-2">
                    <span class="text-content font-semibold text-gray-600">Nama:</span>
                    <span class="text-content font-bold">${currentStudent.name}</span>
                  </div>
                  
                  <div class="flex justify-between items-center pb-3 border-b-2">
                    <span class="text-content font-semibold text-gray-600">Kelas:</span>
                    <span class="text-content font-bold">${currentStudent.class}</span>
                  </div>
                  
                  <div class="flex justify-between items-center">
                    <span class="text-content font-semibold text-gray-600">Status:</span>
                    <span class="font-bold text-xl" style="color: ${existingScore.status === 'Lulus' ? '#16a34a' : '#dc2626'}">${existingScore.status}</span>
                  </div>
                </div>
              </div>
              
              <div class="flex gap-4">
                <button 
                  onclick="reviewAnswers()" 
                  class="btn-primary btn-gradient flex-1 text-white py-4 rounded-xl font-bold transition-all flex items-center justify-center gap-2"
                >
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                  </svg>
                  Review Jawaban
                </button>
                
                <button 
                  onclick="renderLoginScreen()" 
                  class="text-content px-8 py-4 border-2 rounded-xl font-bold hover:bg-gray-50 transition-all flex items-center gap-2"
                >
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                  </svg>
                  Logout
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      applyConfig();
    }

    function reviewAnswers() {
      isExamMode = false;
      const app = document.getElementById('app');
      
      let reviewHTML = `
        <div class="w-full h-full p-6 overflow-auto">
          <div class="max-w-5xl mx-auto">
            <div class="card-bg glass-effect rounded-2xl shadow-2xl p-8 fade-in">
              <div class="flex justify-between items-center mb-8 pb-6 border-b-2 border-gray-100">
                <h2 class="app-title font-bold flex items-center gap-3">
                  <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                  </svg>
                  Review Jawaban
                </h2>
                <button 
                  onclick="renderScorePage()" 
                  class="text-content px-6 py-3 border-2 rounded-xl font-bold hover:bg-gray-50 transition-all flex items-center gap-2"
                >
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                  </svg>
                  Kembali
                </button>
              </div>
      `;
      
      questionsData.forEach((question, qIndex) => {
        const userAnswerData = existingScore.answers.find(a => a.question_id === question.question_id);
        const answers = [question.answer_1, question.answer_2, question.answer_3, question.answer_4].filter(a => a);
        const correctAnswers = answers.filter(a => a.startsWith('*')).map(a => a.substring(1));
        
        reviewHTML += `
          <div class="card-bg rounded-xl p-6 mb-6 border-2 ${userAnswerData.correct ? 'border-green-200' : 'border-red-200'}">
            <div class="flex justify-between items-center mb-5">
              <h3 class="text-content font-bold text-xl flex items-center gap-3">
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white w-10 h-10 rounded-xl flex items-center justify-center font-bold shadow-lg">
                  ${qIndex + 1}
                </div>
                Soal ${qIndex + 1}
              </h3>
              <span class="px-4 py-2 rounded-xl text-sm font-bold ${userAnswerData.correct ? 'bg-gradient-to-r from-green-100 to-green-200 text-green-800' : 'bg-gradient-to-r from-red-100 to-red-200 text-red-800'}">
                ${userAnswerData.correct ? '‚úì Benar' : '‚úó Salah'}
              </span>
            </div>
            
            ${question.image ? `
              <div class="mb-4">
                <img src="${question.image}" alt="Question image" class="max-w-full h-auto rounded-xl shadow-md border-2 border-gray-100" onerror="this.style.display='none'; this.alt='Image failed to load';">
              </div>
            ` : ''}
            
            <p class="text-content mb-5 font-semibold text-lg">${question.question_text}</p>
            
            <div class="space-y-3">
        `;
        
        if (question.question_type === 'TF' || question.question_type === 'MC') {
          answers.forEach(answer => {
            const cleanAnswer = answer.replace('*', '');
            const isCorrect = answer.startsWith('*');
            const isUserAnswer = userAnswerData.response === cleanAnswer;
            
            let className = 'review-answer';
            if (isCorrect) className += ' correct';
            else if (isUserAnswer) className += ' user-answer';
            
            reviewHTML += `
              <div class="${className}">
                <span class="text-content font-medium">${cleanAnswer}</span>
                ${isCorrect ? '<span class="text-green-700 font-bold ml-3">‚úì Jawaban Benar</span>' : ''}
                ${isUserAnswer && !isCorrect ? '<span class="text-blue-700 font-bold ml-3">‚Üê Jawaban Anda</span>' : ''}
              </div>
            `;
          });
        } else if (question.question_type === 'MR') {
          answers.forEach(answer => {
            const cleanAnswer = answer.replace('*', '');
            const isCorrect = answer.startsWith('*');
            const isUserAnswer = Array.isArray(userAnswerData.response) && userAnswerData.response.includes(cleanAnswer);
            
            let className = 'review-answer';
            if (isCorrect) className += ' correct';
            else if (isUserAnswer) className += ' user-answer';
            
            reviewHTML += `
              <div class="${className}">
                <span class="text-content font-medium">${cleanAnswer}</span>
                ${isCorrect ? '<span class="text-green-700 font-bold ml-3">‚úì Jawaban Benar</span>' : ''}
                ${isUserAnswer && !isCorrect ? '<span class="text-blue-700 font-bold ml-3">‚Üê Jawaban Anda</span>' : ''}
              </div>
            `;
          });
        } else if (question.question_type === 'TI' || question.question_type === 'NUMG') {
          reviewHTML += `
            <div class="review-answer ${userAnswerData.correct ? 'correct' : 'incorrect'}">
              <span class="text-content font-bold">Jawaban Anda: </span>
              <span class="text-content font-medium">${userAnswerData.response || '(Tidak dijawab)'}</span>
            </div>
            ${!userAnswerData.correct ? `
              <div class="review-answer correct">
                <span class="text-content font-bold">Jawaban Benar: </span>
                <span class="text-content font-medium">${correctAnswers.join(' atau ')}</span>
              </div>
            ` : ''}
          `;
        } else if (question.question_type === 'MG') {
          const correctPairs = {};
          answers.forEach(a => {
            const [left, right] = a.split('|');
            correctPairs[left.replace('*', '')] = right.replace('*', '');
          });
          
          reviewHTML += `<div class="text-content font-bold mb-3 flex items-center gap-2">
            <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            Pasangan yang Benar:
          </div>`;
          Object.keys(correctPairs).forEach(key => {
            const userMatch = Array.isArray(userAnswerData.response) ? 
              userAnswerData.response.find(r => r.startsWith(key + '|')) : null;
            const userValue = userMatch ? userMatch.split('|')[1] : null;
            const isCorrectMatch = userValue === correctPairs[key];
            
            reviewHTML += `
              <div class="review-answer ${isCorrectMatch ? 'correct' : 'incorrect'}">
                <span class="text-content font-medium">${key} ‚Üí ${correctPairs[key]}</span>
                ${!isCorrectMatch && userValue ? `<span class="text-red-700 ml-3 font-semibold">(Anda: ${userValue})</span>` : ''}
              </div>
            `;
          });
        } else if (question.question_type === 'SEQ') {
          const correctOrder = answers.map(a => a.replace('*', ''));
          
          reviewHTML += `
            <div class="text-content font-bold mb-3 flex items-center gap-2">
              <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              Urutan yang Benar:
            </div>
            <div class="review-answer correct">
          `;
          correctOrder.forEach((item, idx) => {
            reviewHTML += `<div class="text-content font-medium">${idx + 1}. ${item}</div>`;
          });
          reviewHTML += `</div>`;
          
          if (!userAnswerData.correct && Array.isArray(userAnswerData.response)) {
            reviewHTML += `
              <div class="text-content font-bold mb-3 mt-4 flex items-center gap-2">
                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
                Jawaban Anda:
              </div>
              <div class="review-answer user-answer">
            `;
            userAnswerData.response.forEach((item, idx) => {
              reviewHTML += `<div class="text-content font-medium">${idx + 1}. ${item}</div>`;
            });
            reviewHTML += `</div>`;
          }
        }
        
        reviewHTML += `
            </div>
            
            <div class="mt-5 p-4 rounded-xl ${userAnswerData.correct ? 'bg-gradient-to-r from-green-50 to-green-100 border-2 border-green-200' : 'bg-gradient-to-r from-red-50 to-red-100 border-2 border-red-200'}">
              <p class="text-content text-sm font-bold" style="color: ${userAnswerData.correct ? '#16a34a' : '#dc2626'}">
                ${userAnswerData.correct ? '‚úì ' + question.correct_feedback : '‚úó ' + question.incorrect_feedback}
              </p>
            </div>
            
            <div class="mt-4 flex justify-between items-center">
              <span class="text-content font-bold flex items-center gap-2">
                <svg class="w-5 h-5 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                </svg>
                Poin: ${userAnswerData.points_awarded} / ${question.points}
              </span>
            </div>
          </div>
        `;
      });
      
      reviewHTML += `
            </div>
          </div>
        </div>
      `;
      
      app.innerHTML = reviewHTML;
      applyConfig();
    }

    window.previousQuestion = previousQuestion;
    window.nextQuestion = nextQuestion;
    window.finishExam = finishExam;
    window.submitExam = submitExam;
    window.renderLoginScreen = renderLoginScreen;
    window.confirmAndStart = confirmAndStart;
    window.toggleNavigation = toggleNavigation;
    window.updateNavigation = updateNavigation;
    window.renderScorePage = renderScorePage;
    window.reviewAnswers = reviewAnswers;

    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9ad0dda6d6fc3e4d',t:'MTc2NTU4MDcyMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
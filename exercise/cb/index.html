<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Computer Based Test - SMP Negeri 1 Purbalingga</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow-x: hidden;
    }
    html {
      height: 100%;
    }
    .app-container {
      width: 100%;
      min-height: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .question-card {
      transition: all 0.3s ease;
    }
    .option-button {
      transition: all 0.2s ease;
    }
    .option-button:hover {
      transform: translateX(4px);
    }
    .timer-warning {
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    .loading-spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #2563eb;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    input:disabled, button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      z-index: 9999;
      pointer-events: none;
    }
    @keyframes confetti-fall {
      0% {
        transform: translateY(-100vh) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateY(100vh) rotate(720deg);
        opacity: 0;
      }
    }
    .match-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    .draggable {
      cursor: move;
      user-select: none;
    }
    .drop-zone {
      min-height: 40px;
      border: 2px dashed #cbd5e1;
      border-radius: 8px;
      padding: 8px;
    }
    .drop-zone.dragover {
      background-color: #e0e7ff;
      border-color: #4f46e5;
    }
    .floating-nav-button {
      position: fixed;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      z-index: 1000;
      transition: all 0.3s ease;
    }
    .floating-nav-panel {
      position: fixed;
      right: -400px;
      top: 50%;
      transform: translateY(-50%);
      width: 350px;
      max-height: 80%;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      z-index: 999;
      transition: right 0.3s ease;
      overflow-y: auto;
    }
    .floating-nav-panel.active {
      right: 20px;
    }
    .floating-nav-button.hidden {
      right: -100px;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body>
  <div class="app-container" id="app"><!-- Loading Screen -->
   <div id="loadingScreen" class="w-full min-h-full flex items-center justify-center">
    <div class="text-center">
     <div class="loading-spinner mx-auto mb-4"></div>
     <p class="text-gray-600">Memuat data ujian...</p>
    </div>
   </div><!-- Login Screen -->
   <div id="loginScreen" class="w-full min-h-full flex items-center justify-center" style="display: none;">
    <div class="max-w-md w-full mx-4">
     <div class="bg-white rounded-lg shadow-lg p-8">
      <div class="text-center mb-8">
       <div class="w-24 h-24 mx-auto mb-4"><img src="https://spenzaga.github.io/assets/img/logo.png" alt="Logo Sekolah" class="w-full h-full object-contain" onerror="this.src=''; this.alt='Logo gagal dimuat'; this.style.display='none';">
       </div>
       <h1 class="text-3xl font-bold mb-2" id="schoolNameLogin">SMP Negeri 1 Purbalingga</h1>
       <p class="text-xl text-gray-700 mb-4" id="examTitleLogin">Computer Based Test</p>
       <div class="w-16 h-1 bg-blue-600 mx-auto"></div>
      </div>
      <div id="loginError" class="hidden mb-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm"></div>
      <form id="loginForm" class="space-y-4">
       <div><label for="nisInput" class="block text-sm font-medium text-gray-700 mb-2">Nomor Induk Siswa (NIS)</label> <input type="text" id="nisInput" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Masukkan NIS Anda" autocomplete="off">
       </div><button type="submit" id="loginButton" class="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 transition"> Masuk </button>
      </form>
      <div class="mt-6 p-4 bg-yellow-50 rounded-lg">
       <p class="text-sm text-yellow-800"><strong>⚠️ Perhatian:</strong></p>
       <ul class="text-sm text-yellow-700 mt-2 space-y-1 list-disc list-inside">
        <li>Jangan pindah tab atau minimize browser</li>
        <li>Jangan gunakan Google Translate</li>
        <li>Anda hanya dapat mengerjakan satu kali</li>
        <li>Jawaban akan tersimpan otomatis</li>
       </ul>
      </div>
     </div>
    </div>
   </div><!-- Exam Screen -->
   <div id="examScreen" class="w-full min-h-full" style="display: none;"><!-- Header -->
    <div class="w-full bg-blue-600 text-white shadow-lg">
     <div class="max-w-6xl mx-auto px-4 py-4">
      <div class="flex justify-between items-center flex-wrap gap-4">
       <div>
        <h2 class="text-xl font-bold" id="schoolNameExam">SMP Negeri 1 Purbalingga</h2>
        <p class="text-sm opacity-90" id="studentInfo"></p>
       </div>
       <div class="text-right">
        <p class="text-sm opacity-90">Waktu Tersisa</p>
        <p class="text-2xl font-bold" id="timer">90:00</p>
       </div>
      </div>
     </div>
    </div><!-- Floating Navigation Button --> <button id="floatingNavButton" class="floating-nav-button bg-blue-600 text-white px-4 py-3 rounded-l-lg shadow-lg hover:bg-blue-700 transition">
     <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
     </svg>
     <div class="text-xs mt-1">
      Navigasi
     </div></button> <!-- Floating Navigation Panel -->
    <div id="floatingNavPanel" class="floating-nav-panel">
     <div class="sticky top-0 bg-white border-b border-gray-200 p-4 rounded-t-lg">
      <div class="flex justify-between items-center">
       <h3 class="font-bold text-gray-800">Navigasi Soal</h3><button id="closeNavPanel" class="text-gray-500 hover:text-gray-700">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg></button>
      </div>
      <div class="mt-2 text-sm text-gray-600"><span id="answeredCount">0</span> dari <span id="totalCount">0</span> soal terjawab
      </div>
     </div>
     <div class="p-4">
      <div id="floatingQuestionNav" class="grid grid-cols-5 gap-3"></div>
     </div>
    </div><!-- Question Area -->
    <div class="w-full">
     <div class="max-w-4xl mx-auto px-4 py-6">
      <div id="questionContainer" class="bg-white rounded-lg shadow-lg p-6"></div><!-- Navigation Buttons -->
      <div class="flex justify-between mt-6"><button id="prevButton" class="px-6 py-3 bg-gray-500 text-white rounded-lg font-medium hover:bg-gray-600 transition disabled:opacity-50"> ← Sebelumnya </button> <button id="nextButton" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition"> Selanjutnya → </button> <button id="submitButton" class="px-6 py-3 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition" style="display: none;"> Selesai Ujian </button>
      </div>
     </div>
    </div><!-- Warning Toast -->
    <div id="warningToast" class="fixed bottom-4 right-4 bg-red-600 text-white px-6 py-4 rounded-lg shadow-lg" style="display: none;">
     <p class="font-medium">⚠️ Peringatan!</p>
     <p class="text-sm" id="warningMessage"></p>
    </div>
   </div><!-- Result Screen -->
   <div id="resultScreen" class="w-full min-h-full flex items-center justify-center" style="display: none;">
    <div class="max-w-md w-full mx-4">
     <div class="bg-white rounded-lg shadow-lg p-8 text-center">
      <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4"><span class="text-4xl">✓</span>
      </div>
      <h2 class="text-2xl font-bold mb-2">Ujian Selesai!</h2>
      <p class="text-gray-600 mb-6">Jawaban Anda telah berhasil dikirim</p>
      <div class="bg-gray-50 rounded-lg p-4 mb-4 text-left">
       <div class="flex items-center mb-2"><span class="text-sm text-gray-600 w-20">Nama:</span> <span class="font-medium text-gray-800" id="resultStudentName">-</span>
       </div>
       <div class="flex items-center mb-2"><span class="text-sm text-gray-600 w-20">NIS:</span> <span class="font-medium text-gray-800" id="resultStudentNIS">-</span>
       </div>
       <div class="flex items-center"><span class="text-sm text-gray-600 w-20">Kelas:</span> <span class="font-medium text-gray-800" id="resultStudentClass">-</span>
       </div>
      </div>
      <div class="bg-blue-50 rounded-lg p-6 mb-6">
       <p class="text-sm text-gray-600 mb-2">Skor Anda</p>
       <p class="text-4xl font-bold text-blue-600" id="finalScore">0</p>
       <p class="text-sm text-gray-600 mt-2">dari <span id="totalQuestions">0</span> soal</p>
      </div>
      <p class="text-sm text-gray-600">Terima kasih telah mengikuti ujian.</p>
     </div>
    </div>
   </div>
  </div>
  <script>
    // Security measures
    let tabSwitchCount = 0;
    let examStarted = false;
    const MAX_TAB_SWITCHES = 3;

    // Disable right-click and F12
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('keydown', e => {
      if (e.key === 'F12' || 
          (e.ctrlKey && e.shiftKey && e.key === 'I') ||
          (e.ctrlKey && e.shiftKey && e.key === 'J') ||
          (e.ctrlKey && e.key === 'U')) {
        e.preventDefault();
        showWarning('Jangan mencoba membuka developer tools!');
      }
    });

    // Detect tab switch
    document.addEventListener('visibilitychange', () => {
      if (examStarted && document.hidden) {
        tabSwitchCount++;
        showWarning(`Jangan pindah tab! Peringatan ${tabSwitchCount}/${MAX_TAB_SWITCHES}`);
        
        if (tabSwitchCount >= MAX_TAB_SWITCHES) {
          showWarning('Ujian otomatis diselesaikan karena terlalu banyak pindah tab!');
          setTimeout(() => submitExam(true), 2000);
        }
      }
    });

    // Detect Google Translate
    const observer = new MutationObserver(() => {
      if (document.querySelector('font[style*="vertical-align"]') || 
          document.documentElement.classList.contains('translated-ltr')) {
        showWarning('Google Translate terdeteksi! Matikan sekarang.');
      }
    });
    observer.observe(document.body, { childList: true, subtree: true });

    // Global variables
    let questions = [];
    let students = [];
    let currentStudent = null;
    let currentQuestionIndex = 0;
    let answers = {};
    let timerInterval = null;
    let timeRemaining = 5400; // 90 minutes in seconds
    let completedStudents = new Set();

    const defaultConfig = {
      school_name: "SMP Negeri 1 Purbalingga",
      exam_title: "Computer Based Test",
      time_limit: "90",
      pass_score: "75"
    };

    // Load data from CSV
    async function loadData() {
      try {
        const [questionsResponse, studentsResponse] = await Promise.all([
          fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vShD-FggVnTmZjkm_VYH6raebmwcCW9qLdY8JPrJzMHZSGlI5O1lF9prNziinNA7YwyoPgZQal_nlkm/pub?gid=1299383846&single=true&output=csv'),
          fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vShD-FggVnTmZjkm_VYH6raebmwcCW9qLdY8JPrJzMHZSGlI5O1lF9prNziinNA7YwyoPgZQal_nlkm/pub?gid=1534064510&single=true&output=csv')
        ]);

        const questionsText = await questionsResponse.text();
        const studentsText = await studentsResponse.text();

        console.log('Questions CSV loaded:', questionsText.substring(0, 200));
        console.log('Students CSV loaded:', studentsText.substring(0, 200));

        parseQuestions(questionsText);
        parseStudents(studentsText);

        console.log('Total questions parsed:', questions.length);
        console.log('Total students parsed:', students.length);
        console.log('Sample students:', students.slice(0, 3));

        if (questions.length === 0) {
          showError('Tidak ada soal yang berhasil dimuat. Periksa format CSV soal.');
          return;
        }

        if (students.length === 0) {
          showError('Tidak ada data siswa yang berhasil dimuat. Periksa format CSV siswa.');
          return;
        }

        document.getElementById('loadingScreen').style.display = 'none';
        document.getElementById('loginScreen').style.display = 'flex';
      } catch (error) {
        console.error('Error loading data:', error);
        showError('Gagal memuat data. Silakan refresh halaman. Error: ' + error.message);
      }
    }

    function parseQuestions(csv) {
      const lines = csv.trim().split('\n');
      const headers = lines[0].split(',');
      
      for (let i = 1; i < lines.length; i++) {
        const values = parseCSVLine(lines[i]);
        if (values.length < 2) continue;

        const question = {
          type: values[0],
          question: values[1],
          image: values[2] || null,
          video: values[3] || null,
          audio: values[4] || null,
          options: [],
          correctAnswer: null,
          correctFeedback: null,
          incorrectFeedback: null,
          points: 1
        };

        if (question.type === 'TF') {
          const opt1 = values[5] || '';
          const opt2 = values[6] || '';
          question.options = [
            opt1.replace('*', '').trim(),
            opt2.replace('*', '').trim()
          ];
          const correctOpt = [opt1, opt2].find(o => o.startsWith('*'));
          question.correctAnswer = correctOpt ? correctOpt.replace('*', '').trim() : null;
          question.correctFeedback = values[9];
          question.incorrectFeedback = values[10];
          question.points = parseFloat(values[11]) || 1;
        } else if (question.type === 'MC') {
          const opts = [values[5], values[6], values[7], values[8]].filter(o => o);
          question.options = opts.map(o => o.replace('*', '').trim());
          const correctOpt = opts.find(o => o.startsWith('*'));
          question.correctAnswer = correctOpt ? correctOpt.replace('*', '').trim() : null;
          question.correctFeedback = values[9];
          question.incorrectFeedback = values[10];
          question.points = parseFloat(values[11]) || 1;
        } else if (question.type === 'MR') {
          const opts = [values[5], values[6], values[7], values[8]].filter(o => o);
          question.options = opts.map(o => o.replace('*', '').trim());
          question.correctAnswer = opts.filter(o => o.startsWith('*')).map(o => o.replace('*', '').trim());
          question.correctFeedback = values[9];
          question.incorrectFeedback = values[10];
          question.points = parseFloat(values[11]) || 1;
        } else if (question.type === 'TI') {
          const acceptedAnswers = [values[5], values[6], values[7], values[8]]
            .filter(a => a)
            .map(a => a.replace('*', '').trim());
          question.correctAnswer = acceptedAnswers;
          question.correctFeedback = values[9];
          question.incorrectFeedback = values[10];
          question.points = parseFloat(values[11]) || 1;
        } else if (question.type === 'MG') {
          const pairData = [values[5], values[6], values[7], values[8]].filter(p => p);
          const pairs = [];
          pairData.forEach(p => {
            const parts = p.split('|');
            if (parts.length === 2) {
              pairs.push({ left: parts[0].trim(), right: parts[1].trim() });
            }
          });
          question.pairs = pairs;
          question.correctAnswer = pairs.map((p, idx) => ({ leftIdx: idx, rightIdx: idx }));
          question.correctFeedback = values[9];
          question.incorrectFeedback = values[10];
          question.points = parseFloat(values[11]) || 1;
        } else if (question.type === 'SEQ') {
          question.items = [values[5], values[6], values[7], values[8]].filter(i => i).map(i => i.trim());
          question.correctAnswer = question.items.slice();
          question.correctFeedback = values[9];
          question.incorrectFeedback = values[10];
          question.points = parseFloat(values[11]) || 1;
        } else if (question.type === 'NUMG') {
          const ans = values[5] || '';
          question.correctAnswer = parseFloat(ans.replace('*', '').trim());
          question.tolerance = 0.01;
          question.correctFeedback = values[9];
          question.incorrectFeedback = values[10];
          question.points = parseFloat(values[11]) || 1;
        }

        questions.push(question);
      }
    }

    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;

      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current.trim());
      return result;
    }

    function parseStudents(csv) {
      const lines = csv.trim().split('\n');
      console.log('First line (header):', lines[0]);
      for (let i = 1; i < lines.length; i++) {
        if (!lines[i].trim()) continue;
        const values = parseCSVLine(lines[i]);
        console.log(`Row ${i} values:`, values);
        if (values.length >= 4) {
          const student = {
            absen: values[0].trim(),
            nis: values[1].trim(),
            nama: values[2].trim(),
            kelas: values[3].trim()
          };
          console.log('Parsed student:', student);
          students.push(student);
        }
      }
    }

    // Login handler
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const nis = document.getElementById('nisInput').value.trim();
      const loginButton = document.getElementById('loginButton');
      const loginError = document.getElementById('loginError');

      console.log('Login attempt with NIS:', nis);
      console.log('Available students:', students);
      console.log('Students NIS list:', students.map(s => s.nis));

      loginError.classList.add('hidden');

      if (completedStudents.has(nis)) {
        loginError.textContent = 'Anda sudah menyelesaikan ujian. Tidak dapat mengerjakan lagi.';
        loginError.classList.remove('hidden');
        return;
      }

      // Try to find student with exact match first
      let student = students.find(s => s.nis === nis);
      
      // If not found, try case-insensitive and trim whitespace
      if (!student) {
        student = students.find(s => s.nis.toLowerCase() === nis.toLowerCase());
      }
      
      // If still not found, try removing all whitespace
      if (!student) {
        const cleanNIS = nis.replace(/\s+/g, '');
        student = students.find(s => s.nis.replace(/\s+/g, '') === cleanNIS);
      }

      console.log('Found student:', student);

      if (!student) {
        loginError.textContent = `NIS "${nis}" tidak ditemukan. Silakan periksa kembali. Total siswa terdaftar: ${students.length}`;
        loginError.classList.remove('hidden');
        return;
      }

      currentStudent = student;
      completedStudents.add(nis);
      
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('examScreen').style.display = 'block';
      
      const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
      document.getElementById('studentInfo').textContent = `${student.nama} (${student.kelas}) - ${student.nis}`;
      
      timeRemaining = parseInt(config.time_limit || defaultConfig.time_limit) * 60;
      startExam();
    });

    function startExam() {
      examStarted = true;
      renderQuestionNav();
      renderQuestion();
      startTimer();
      setupFloatingNav();
    }

    function setupFloatingNav() {
      const floatingButton = document.getElementById('floatingNavButton');
      const floatingPanel = document.getElementById('floatingNavPanel');
      const closeButton = document.getElementById('closeNavPanel');

      floatingButton.onclick = () => {
        floatingPanel.classList.add('active');
        floatingButton.classList.add('hidden');
      };

      closeButton.onclick = () => {
        floatingPanel.classList.remove('active');
        floatingButton.classList.remove('hidden');
      };

      // Close when clicking outside
      document.addEventListener('click', (e) => {
        if (!floatingPanel.contains(e.target) && !floatingButton.contains(e.target)) {
          if (floatingPanel.classList.contains('active')) {
            floatingPanel.classList.remove('active');
            floatingButton.classList.remove('hidden');
          }
        }
      });
    }

    function startTimer() {
      timerInterval = setInterval(() => {
        timeRemaining--;
        updateTimerDisplay();

        if (timeRemaining <= 0) {
          clearInterval(timerInterval);
          showWarning('Waktu habis! Ujian otomatis diselesaikan.');
          setTimeout(() => submitExam(true), 2000);
        }
      }, 1000);
    }

    function updateTimerDisplay() {
      const minutes = Math.floor(timeRemaining / 60);
      const seconds = timeRemaining % 60;
      const timerEl = document.getElementById('timer');
      timerEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      
      if (timeRemaining <= 300) {
        timerEl.classList.add('timer-warning');
      }
    }

    function renderQuestionNav() {
      const nav = document.getElementById('floatingQuestionNav');
      nav.innerHTML = '';
      
      let answeredCount = 0;
      
      questions.forEach((q, index) => {
        const btn = document.createElement('button');
        btn.textContent = index + 1;
        btn.className = 'w-12 h-12 rounded-lg font-medium transition flex items-center justify-center';
        
        if (answers[index] !== undefined) {
          btn.className += ' bg-green-500 text-white hover:bg-green-600';
          answeredCount++;
        } else if (index === currentQuestionIndex) {
          btn.className += ' bg-blue-600 text-white ring-2 ring-blue-300';
        } else {
          btn.className += ' bg-white border-2 border-gray-300 text-gray-700 hover:bg-gray-100 hover:border-blue-400';
        }
        
        btn.onclick = () => {
          currentQuestionIndex = index;
          renderQuestion();
          renderQuestionNav();
          // Close panel after selection
          document.getElementById('floatingNavPanel').classList.remove('active');
          document.getElementById('floatingNavButton').classList.remove('hidden');
        };
        
        nav.appendChild(btn);
      });

      // Update counter
      document.getElementById('answeredCount').textContent = answeredCount;
      document.getElementById('totalCount').textContent = questions.length;
    }

    function renderQuestion() {
      const container = document.getElementById('questionContainer');
      const question = questions[currentQuestionIndex];
      
      let mediaHTML = '';
      if (question.image) {
        mediaHTML += `<img src="${question.image}" alt="Question image" class="max-w-full h-auto rounded-lg mb-4 shadow-md" onerror="this.style.display='none'; this.alt='Gambar gagal dimuat';">`;
      }
      if (question.audio) {
        mediaHTML += `<audio controls class="w-full mb-4"><source src="${question.audio}" type="audio/mpeg">Browser Anda tidak mendukung audio.</audio>`;
      }
      if (question.video) {
        mediaHTML += `<video controls class="w-full rounded-lg mb-4 shadow-md"><source src="${question.video}" type="video/mp4">Browser Anda tidak mendukung video.</video>`;
      }

      container.innerHTML = `
        <div class="question-card fade-in">
          <div class="mb-4">
            <span class="inline-block px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium mb-2">
              ${getQuestionTypeLabel(question.type)}
            </span>
            <p class="text-sm text-gray-600">Soal ${currentQuestionIndex + 1} dari ${questions.length}</p>
          </div>
          ${mediaHTML}
          <h3 class="text-xl font-bold mb-4">${question.question}</h3>
          <div id="answerArea"></div>
        </div>
      `;

      renderAnswerArea(question);
      updateNavigationButtons();
    }

    function getQuestionTypeLabel(type) {
      const labels = {
        'TF': 'Benar/Salah',
        'MC': 'Pilihan Ganda',
        'MR': 'Jawaban Ganda',
        'TI': 'Jawaban Singkat',
        'MG': 'Menjodohkan',
        'SEQ': 'Urutan',
        'NUMG': 'Numerik'
      };
      return labels[type] || type;
    }

    function renderAnswerArea(question) {
      const area = document.getElementById('answerArea');
      const currentAnswer = answers[currentQuestionIndex];

      if (question.type === 'TF' || question.type === 'MC') {
        question.options.forEach((option, index) => {
          const btn = document.createElement('button');
          btn.className = 'option-button w-full text-left p-4 mb-3 rounded-lg border-2 transition';
          btn.className += currentAnswer === option ? ' border-blue-600 bg-blue-50' : ' border-gray-300 hover:border-blue-400';
          btn.innerHTML = `
            <span class="inline-block w-8 h-8 rounded-full border-2 mr-3 text-center leading-7 ${currentAnswer === option ? 'border-blue-600 bg-blue-600 text-white' : 'border-gray-400'}">
              ${String.fromCharCode(65 + index)}
            </span>
            ${option}
          `;
          btn.onclick = () => {
            answers[currentQuestionIndex] = option;
            renderQuestion();
            renderQuestionNav();
          };
          area.appendChild(btn);
        });
      } else if (question.type === 'MR') {
        question.options.forEach((option, index) => {
          const div = document.createElement('div');
          div.className = 'flex items-start p-4 mb-3 rounded-lg border-2 border-gray-300 hover:border-blue-400 transition cursor-pointer';
          
          const checked = currentAnswer && currentAnswer.includes(option);
          div.innerHTML = `
            <input type="checkbox" id="opt${index}" ${checked ? 'checked' : ''} class="mt-1 w-5 h-5 text-blue-600">
            <label for="opt${index}" class="ml-3 cursor-pointer flex-1">${option}</label>
          `;
          
          div.onclick = () => {
            const checkbox = div.querySelector('input');
            checkbox.checked = !checkbox.checked;
            
            if (!answers[currentQuestionIndex]) {
              answers[currentQuestionIndex] = [];
            }
            
            if (checkbox.checked) {
              if (!answers[currentQuestionIndex].includes(option)) {
                answers[currentQuestionIndex].push(option);
              }
            } else {
              answers[currentQuestionIndex] = answers[currentQuestionIndex].filter(a => a !== option);
            }
            
            renderQuestionNav();
          };
          
          area.appendChild(div);
        });
      } else if (question.type === 'TI') {
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'w-full p-4 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent';
        input.placeholder = 'Ketik jawaban Anda...';
        input.value = currentAnswer || '';
        input.oninput = (e) => {
          answers[currentQuestionIndex] = e.target.value;
          renderQuestionNav();
        };
        area.appendChild(input);
      } else if (question.type === 'NUMG') {
        const input = document.createElement('input');
        input.type = 'number';
        input.step = 'any';
        input.className = 'w-full p-4 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent';
        input.placeholder = 'Masukkan angka...';
        input.value = currentAnswer !== undefined ? currentAnswer : '';
        input.oninput = (e) => {
          answers[currentQuestionIndex] = parseFloat(e.target.value);
          renderQuestionNav();
        };
        area.appendChild(input);
      } else if (question.type === 'MG') {
        renderMatchingQuestion(question, area, currentAnswer);
      } else if (question.type === 'SEQ') {
        renderSequenceQuestion(question, area, currentAnswer);
      }
    }

    function renderMatchingQuestion(question, area, currentAnswer) {
      const matchDiv = document.createElement('div');
      matchDiv.className = 'space-y-4';
      
      const leftItems = question.pairs.map(p => p.left);
      const rightItems = question.pairs.map(p => p.right);
      
      // Shuffle right items if not already done for this question
      if (!question.shuffledRightItems) {
        question.shuffledRightItems = shuffleArray([...rightItems]);
        // Create mapping from shuffled position to original position
        question.shuffleMapping = question.shuffledRightItems.map(item => 
          rightItems.indexOf(item)
        );
      }
      
      if (!currentAnswer) {
        currentAnswer = {};
        answers[currentQuestionIndex] = currentAnswer;
      }
      
      leftItems.forEach((left, leftIdx) => {
        const pairDiv = document.createElement('div');
        pairDiv.className = 'flex items-center gap-4 p-4 bg-gray-50 rounded-lg';
        
        pairDiv.innerHTML = `
          <div class="flex-1 font-medium">${left}</div>
          <div class="text-gray-400">↔</div>
          <select class="flex-1 p-2 border-2 border-gray-300 rounded-lg" data-left-idx="${leftIdx}">
            <option value="">Pilih pasangan...</option>
            ${question.shuffledRightItems.map((right, shuffledIdx) => {
              const originalIdx = question.shuffleMapping[shuffledIdx];
              return `
                <option value="${originalIdx}" ${currentAnswer[leftIdx] === originalIdx ? 'selected' : ''}>
                  ${right}
                </option>
              `;
            }).join('')}
          </select>
        `;
        
        pairDiv.querySelector('select').onchange = (e) => {
          const selectedOriginalIdx = e.target.value ? parseInt(e.target.value) : null;
          answers[currentQuestionIndex][leftIdx] = selectedOriginalIdx;
          renderQuestionNav();
        };
        
        matchDiv.appendChild(pairDiv);
      });
      
      area.appendChild(matchDiv);
    }

    function renderSequenceQuestion(question, area, currentAnswer) {
      const items = currentAnswer || shuffleArray([...question.items]);
      
      const seqDiv = document.createElement('div');
      seqDiv.className = 'space-y-3';
      seqDiv.innerHTML = '<p class="text-sm text-gray-600 mb-3">Klik dan seret untuk mengurutkan:</p>';
      
      items.forEach((item, idx) => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'draggable p-4 bg-white border-2 border-gray-300 rounded-lg cursor-move hover:border-blue-400 transition';
        itemDiv.draggable = true;
        itemDiv.innerHTML = `
          <span class="inline-block w-8 h-8 bg-blue-100 text-blue-800 rounded-full text-center leading-8 mr-3 font-medium">
            ${idx + 1}
          </span>
          ${item}
        `;
        
        itemDiv.ondragstart = (e) => {
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/html', idx.toString());
          itemDiv.classList.add('opacity-50');
        };
        
        itemDiv.ondragend = () => {
          itemDiv.classList.remove('opacity-50');
        };
        
        itemDiv.ondragover = (e) => {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';
        };
        
        itemDiv.ondrop = (e) => {
          e.preventDefault();
          const fromIdx = parseInt(e.dataTransfer.getData('text/html'));
          const toIdx = idx;
          
          if (fromIdx !== toIdx) {
            const newItems = [...items];
            const [movedItem] = newItems.splice(fromIdx, 1);
            newItems.splice(toIdx, 0, movedItem);
            answers[currentQuestionIndex] = newItems;
            renderQuestion();
            renderQuestionNav();
          }
        };
        
        seqDiv.appendChild(itemDiv);
      });
      
      area.appendChild(seqDiv);
    }

    function shuffleArray(array) {
      const newArray = [...array];
      for (let i = newArray.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
      }
      return newArray;
    }

    function updateNavigationButtons() {
      const prevBtn = document.getElementById('prevButton');
      const nextBtn = document.getElementById('nextButton');
      const submitBtn = document.getElementById('submitButton');

      prevBtn.disabled = currentQuestionIndex === 0;

      if (currentQuestionIndex === questions.length - 1) {
        nextBtn.style.display = 'none';
        submitBtn.style.display = 'block';
      } else {
        nextBtn.style.display = 'block';
        submitBtn.style.display = 'none';
      }
    }

    document.getElementById('prevButton').onclick = () => {
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        renderQuestion();
        renderQuestionNav();
      }
    };

    document.getElementById('nextButton').onclick = () => {
      if (currentQuestionIndex < questions.length - 1) {
        currentQuestionIndex++;
        renderQuestion();
        renderQuestionNav();
      }
    };

    document.getElementById('submitButton').onclick = () => {
      const unanswered = questions.length - Object.keys(answers).length;
      if (unanswered > 0) {
        showWarning(`Masih ada ${unanswered} soal yang belum dijawab. Yakin ingin selesai?`);
        setTimeout(() => {
          const confirmDiv = document.createElement('div');
          confirmDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
          confirmDiv.innerHTML = `
            <div class="bg-white rounded-lg p-6 max-w-md mx-4">
              <h3 class="text-xl font-bold mb-4">Konfirmasi</h3>
              <p class="mb-6">Apakah Anda yakin ingin menyelesaikan ujian?</p>
              <div class="flex gap-3 justify-end">
                <button id="cancelSubmit" class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Batal</button>
                <button id="confirmSubmit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Ya, Selesai</button>
              </div>
            </div>
          `;
          document.body.appendChild(confirmDiv);
          
          document.getElementById('cancelSubmit').onclick = () => {
            document.body.removeChild(confirmDiv);
          };
          
          document.getElementById('confirmSubmit').onclick = () => {
            document.body.removeChild(confirmDiv);
            submitExam(false);
          };
        }, 1000);
      } else {
        submitExam(false);
      }
    };

    async function submitExam(autoSubmit) {
      if (timerInterval) {
        clearInterval(timerInterval);
      }
      examStarted = false;

      const score = calculateScore();
      
      const submitBtn = document.getElementById('submitButton');
      const nextBtn = document.getElementById('nextButton');
      submitBtn.disabled = true;
      nextBtn.disabled = true;
      submitBtn.textContent = 'Mengirim...';

      try {
        const formData = new FormData();
        formData.append('NIS', currentStudent.nis);
        formData.append('Absen', currentStudent.absen);
        formData.append('Nama', currentStudent.nama);
        formData.append('Kelas', currentStudent.kelas);
        formData.append('Skor', score);

        await fetch('https://script.google.com/macros/s/AKfycbyD255R7kBMEdE5yDUA8WmQMelB6t8MkP0tlWhcKI64X7slv6kZFaly-xCX-BWTFC7q/exec', {
          method: 'POST',
          body: formData
        });

        document.getElementById('examScreen').style.display = 'none';
        document.getElementById('resultScreen').style.display = 'flex';
        document.getElementById('finalScore').textContent = score;
        document.getElementById('totalQuestions').textContent = questions.length;
        document.getElementById('resultStudentName').textContent = currentStudent.nama;
        document.getElementById('resultStudentNIS').textContent = currentStudent.nis;
        document.getElementById('resultStudentClass').textContent = currentStudent.kelas;
        
        // Show confetti for high scores (80 or above)
        if (score >= 80) {
          setTimeout(() => {
            createConfetti();
          }, 500);
        }
      } catch (error) {
        showWarning('Gagal mengirim hasil. Silakan hubungi pengawas.');
        submitBtn.disabled = false;
        nextBtn.disabled = false;
        submitBtn.textContent = 'Selesai Ujian';
      }
    }

    function calculateScore() {
      let correct = 0;
      
      questions.forEach((question, index) => {
        const answer = answers[index];
        if (answer === undefined) return;

        if (question.type === 'TF' || question.type === 'MC') {
          if (answer === question.correctAnswer) {
            correct++;
          }
        } else if (question.type === 'TI') {
          if (Array.isArray(question.correctAnswer)) {
            const normalizedAnswer = answer.toLowerCase().trim();
            const isCorrect = question.correctAnswer.some(correctAns => 
              normalizedAnswer === correctAns.toLowerCase().trim()
            );
            if (isCorrect) {
              correct++;
            }
          } else if (answer === question.correctAnswer) {
            correct++;
          }
        } else if (question.type === 'MR') {
          if (Array.isArray(answer) && Array.isArray(question.correctAnswer)) {
            const answerSet = new Set(answer);
            const correctSet = new Set(question.correctAnswer);
            if (answerSet.size === correctSet.size && [...answerSet].every(a => correctSet.has(a))) {
              correct++;
            }
          }
        } else if (question.type === 'NUMG') {
          const numAnswer = parseFloat(answer);
          if (!isNaN(numAnswer) && Math.abs(numAnswer - question.correctAnswer) <= question.tolerance) {
            correct++;
          }
        } else if (question.type === 'MG') {
          if (typeof answer === 'object' && !Array.isArray(answer)) {
            const allCorrect = Object.keys(answer).every(leftIdx => {
              return answer[leftIdx] === parseInt(leftIdx);
            });
            if (allCorrect && Object.keys(answer).length === question.pairs.length) {
              correct++;
            }
          }
        } else if (question.type === 'SEQ') {
          if (Array.isArray(answer) && answer.every((item, idx) => item === question.correctAnswer[idx])) {
            correct++;
          }
        }
      });

      return Math.round((correct / questions.length) * 100);
    }

    function showWarning(message) {
      const toast = document.getElementById('warningToast');
      const messageEl = document.getElementById('warningMessage');
      messageEl.textContent = message;
      toast.style.display = 'block';
      
      setTimeout(() => {
        toast.style.display = 'none';
      }, 4000);
    }

    function showError(message) {
      const loadingScreen = document.getElementById('loadingScreen');
      loadingScreen.innerHTML = `
        <div class="text-center">
          <div class="text-red-600 text-4xl mb-4">⚠️</div>
          <p class="text-gray-800 font-medium mb-2">Terjadi Kesalahan</p>
          <p class="text-gray-600">${message}</p>
        </div>
      `;
    }

    function createConfetti() {
      const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff', '#ffa500', '#ff1493'];
      const confettiCount = 100;
      
      for (let i = 0; i < confettiCount; i++) {
        setTimeout(() => {
          const confetti = document.createElement('div');
          confetti.className = 'confetti';
          confetti.style.left = Math.random() * 100 + '%';
          confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
          confetti.style.animation = `confetti-fall ${3 + Math.random() * 2}s linear forwards`;
          confetti.style.animationDelay = Math.random() * 0.5 + 's';
          document.body.appendChild(confetti);
          
          setTimeout(() => {
            confetti.remove();
          }, 5500);
        }, i * 30);
      }
    }

    // Element SDK Integration
    async function onConfigChange(config) {
      const schoolNameLogin = document.getElementById('schoolNameLogin');
      const examTitleLogin = document.getElementById('examTitleLogin');
      const schoolNameExam = document.getElementById('schoolNameExam');

      if (schoolNameLogin) {
        schoolNameLogin.textContent = config.school_name || defaultConfig.school_name;
      }
      if (examTitleLogin) {
        examTitleLogin.textContent = config.exam_title || defaultConfig.exam_title;
      }
      if (schoolNameExam) {
        schoolNameExam.textContent = config.school_name || defaultConfig.school_name;
      }
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities: (config) => ({
          recolorables: [],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (config) => new Map([
          ['school_name', config.school_name || defaultConfig.school_name],
          ['exam_title', config.exam_title || defaultConfig.exam_title],
          ['time_limit', config.time_limit || defaultConfig.time_limit],
          ['pass_score', config.pass_score || defaultConfig.pass_score]
        ])
      });
    }

    // Initialize app
    loadData();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9aa05798e448d899',t:'MTc2NTA3MTkxMi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
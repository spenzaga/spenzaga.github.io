<!DOCTYPE html>
<html lang="id" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuis Interaktif</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        .bounce-in {
            animation: bounceIn 0.6s ease-out;
        }
        
        .shake {
            animation: shake 0.5s ease-in-out;
        }
        
        .pulse-success {
            animation: pulseSuccess 0.8s ease-in-out;
        }
        
        .pulse-error {
            animation: pulseError 0.8s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
            20%, 40%, 60%, 80% { transform: translateX(10px); }
        }
        
        @keyframes pulseSuccess {
            0% { background-color: rgb(34, 197, 94); transform: scale(1); }
            50% { background-color: rgb(22, 163, 74); transform: scale(1.05); }
            100% { background-color: rgb(34, 197, 94); transform: scale(1); }
        }
        
        @keyframes pulseError {
            0% { background-color: rgb(239, 68, 68); transform: scale(1); }
            50% { background-color: rgb(220, 38, 38); transform: scale(1.05); }
            100% { background-color: rgb(239, 68, 68); transform: scale(1); }
        }
        
        .progress-bar {
            transition: width 0.3s ease-in-out;
        }
        
        .warning-popup {
            animation: warningPulse 0.5s ease-in-out;
        }
        
        @keyframes warningPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .no-select {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        .timer-warning {
            animation: timerBlink 1s infinite;
        }
        
        @keyframes timerBlink {
            0%, 50% { color: rgb(239, 68, 68); }
            51%, 100% { color: rgb(220, 38, 38); }
        }
    </style>
</head>
<body class="h-full bg-gradient-to-br from-blue-900 via-purple-900 to-indigo-900 font-sans no-select">
    <!-- Login Screen -->
    <div id="loginScreen" class="h-full flex items-center justify-center p-4">
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 w-full max-w-md shadow-2xl border border-white/20 fade-in">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-white mb-2">🎯 Kuis Interaktif</h1>
                <p class="text-blue-200">Masuk untuk memulai kuis</p>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label for="username" class="block text-sm font-medium text-white mb-2">Username</label>
                    <input type="text" id="username" required 
                           class="w-full px-4 py-3 bg-white/20 border border-white/30 rounded-lg text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent transition-all">
                </div>
                
                <div>
                    <label for="password" class="block text-sm font-medium text-white mb-2">Password</label>
                    <input type="password" id="password" required 
                           class="w-full px-4 py-3 bg-white/20 border border-white/30 rounded-lg text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent transition-all">
                </div>
                
                <button type="submit" 
                        class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 px-6 rounded-lg font-semibold hover:from-blue-600 hover:to-purple-700 transform hover:scale-105 transition-all duration-200 shadow-lg">
                    Masuk
                </button>
            </form>
            
            <div id="loginError" class="mt-4 text-red-300 text-center hidden"></div>
        </div>
    </div>

    <!-- Profile Screen -->
    <div id="profileScreen" class="h-full flex items-center justify-center p-4 hidden">
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 w-full max-w-md shadow-2xl border border-white/20 bounce-in">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-r from-blue-400 to-purple-500 rounded-full mx-auto mb-4 flex items-center justify-center text-2xl">
                    👤
                </div>
                <h2 class="text-2xl font-bold text-white mb-2">Profil Peserta</h2>
            </div>
            
            <div class="space-y-4 mb-8">
                <div class="bg-white/10 rounded-lg p-4">
                    <p class="text-blue-200 text-sm">No. Absen</p>
                    <p id="profileAbsen" class="text-white font-semibold text-lg"></p>
                </div>
                <div class="bg-white/10 rounded-lg p-4">
                    <p class="text-blue-200 text-sm">Nama Lengkap</p>
                    <p id="profileNama" class="text-white font-semibold text-lg"></p>
                </div>
                <div class="bg-white/10 rounded-lg p-4">
                    <p class="text-blue-200 text-sm">Kelas</p>
                    <p id="profileKelas" class="text-white font-semibold text-lg"></p>
                </div>
            </div>
            
            <button id="startQuizBtn" 
                    class="w-full bg-gradient-to-r from-green-500 to-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:from-green-600 hover:to-blue-700 transform hover:scale-105 transition-all duration-200 shadow-lg">
                🚀 Mulai Kuis
            </button>
        </div>
    </div>

    <!-- Quiz Screen -->
    <div id="quizScreen" class="h-full flex flex-col hidden">
        <!-- Header -->
        <div class="bg-white/10 backdrop-blur-lg border-b border-white/20 p-4">
            <div class="flex justify-between items-center max-w-6xl mx-auto">
                <div class="flex items-center space-x-4">
                    <h1 class="text-xl font-bold text-white">🎯 Kuis Interaktif</h1>
                    <div class="bg-white/20 rounded-lg px-3 py-1">
                        <span class="text-white text-sm">Soal <span id="currentQuestion">1</span> dari <span id="totalQuestions">0</span></span>
                    </div>
                    <button id="toggleNavBtn" class="bg-white/20 hover:bg-white/30 rounded-lg px-3 py-1 text-white text-sm transition-all">
                        📋 Menu
                    </button>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div class="bg-white/20 rounded-lg px-3 py-1">
                        <span class="text-white text-sm">Skor: <span id="currentScore">0</span></span>
                    </div>
                    <div class="bg-white/20 rounded-lg px-3 py-1">
                        <span id="timer" class="text-white text-sm font-mono">60:00</span>
                    </div>
                    <div class="bg-white/20 rounded-lg px-3 py-1">
                        <span class="text-white text-sm">Peringatan: <span id="warningCount">0</span>/3</span>
                    </div>
                </div>
            </div>
            
            <!-- Progress Bar -->
            <div class="max-w-6xl mx-auto mt-4">
                <div class="bg-white/20 rounded-full h-2">
                    <div id="progressBar" class="bg-gradient-to-r from-green-400 to-blue-500 h-2 rounded-full progress-bar" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Question Content -->
        <div class="flex-1 overflow-y-auto p-6">
            <div class="max-w-6xl mx-auto flex gap-6">
                <!-- Question Navigation Sidebar -->
                <div id="navigationSidebar" class="w-64 flex-shrink-0 transition-all duration-300">
                    <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-4 shadow-2xl border border-white/20 sticky top-0">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-white font-semibold text-center">📋 Navigasi Soal</h3>
                            <button id="closeNavBtn" class="text-white hover:text-red-300 transition-all">✕</button>
                        </div>
                        <div id="questionNavigation" class="grid grid-cols-5 gap-2">
                            <!-- Question numbers will be inserted here -->
                        </div>
                        <div class="mt-4 text-xs text-blue-200 text-center">
                            <div class="flex items-center justify-center gap-2 mb-1">
                                <div class="w-3 h-3 bg-green-500 rounded"></div>
                                <span>Benar</span>
                            </div>
                            <div class="flex items-center justify-center gap-2 mb-1">
                                <div class="w-3 h-3 bg-red-500 rounded"></div>
                                <span>Salah</span>
                            </div>
                            <div class="flex items-center justify-center gap-2">
                                <div class="w-3 h-3 bg-blue-500 rounded"></div>
                                <span>Aktif</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Question Area -->
                <div class="flex-1">
                    <div id="questionCard" class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 shadow-2xl border border-white/20 slide-in">
                        <div id="questionImage" class="mb-6 hidden">
                            <img id="questionImg" src="" alt="Gambar Soal" class="w-full max-w-md mx-auto rounded-lg shadow-lg">
                        </div>
                        
                        <h2 id="questionText" class="text-xl font-semibold text-white mb-8 leading-relaxed"></h2>
                        
                        <div id="optionsContainer" class="space-y-4">
                            <!-- Options will be inserted here -->
                        </div>
                        
                        <div id="feedback" class="mt-6 hidden">
                            <div id="feedbackContent" class="p-4 rounded-lg"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="bg-white/10 backdrop-blur-lg border-t border-white/20 p-4">
            <div class="max-w-4xl mx-auto flex justify-end">
                <button id="prevBtn" 
                        class="bg-gray-600 text-white py-2 px-6 rounded-lg font-semibold hover:bg-gray-700 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed" style="display: none;">
                    ← Sebelumnya
                </button>
                
                <button id="nextBtn" 
                        class="bg-gradient-to-r from-blue-500 to-purple-600 text-white py-2 px-6 rounded-lg font-semibold hover:from-blue-600 hover:to-purple-700 transition-all duration-200">
                    Selanjutnya →
                </button>
            </div>
        </div>
    </div>

    <!-- Result Screen -->
    <div id="resultScreen" class="h-full flex items-center justify-center p-4 hidden">
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 w-full max-w-2xl shadow-2xl border border-white/20 bounce-in">
            <div class="text-center">
                <div id="resultIcon" class="text-6xl mb-4">🎉</div>
                <h2 class="text-3xl font-bold text-white mb-4">Kuis Selesai!</h2>
                
                <div class="bg-white/10 rounded-xl p-6 mb-6">
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div>
                            <p class="text-blue-200 text-sm">Skor Akhir</p>
                            <p id="finalScore" class="text-3xl font-bold text-white"></p>
                        </div>
                        <div>
                            <p class="text-blue-200 text-sm">Persentase</p>
                            <p id="finalPercentage" class="text-3xl font-bold text-white"></p>
                        </div>
                    </div>
                </div>
                
                <div id="scoreMessage" class="text-lg text-white mb-6"></div>
                
                <p class="text-blue-200 text-sm">Kembali ke login dalam <span id="countdown">2</span> detik...</p>
            </div>
        </div>
    </div>

    <!-- Warning Modal -->
    <div id="warningModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="bg-red-600 text-white p-6 rounded-2xl shadow-2xl max-w-md mx-4 warning-popup">
            <div class="text-center">
                <div class="text-4xl mb-4">⚠️</div>
                <h3 class="text-xl font-bold mb-2">Peringatan!</h3>
                <p id="warningMessage" class="mb-4"></p>
                <p class="text-sm opacity-90">Peringatan: <span id="warningModalCount">1</span>/3</p>
                <button id="warningOkBtn" class="mt-4 bg-white text-red-600 px-6 py-2 rounded-lg font-semibold hover:bg-gray-100 transition-all">
                    Mengerti
                </button>
            </div>
        </div>
    </div>

    <script>
        class QuizApp {
            constructor() {
                this.currentUser = null;
                this.questions = [];
                this.currentQuestionIndex = 0;
                this.score = 0;
                this.answers = [];
                this.timeLeft = 3600; // 60 minutes in seconds
                this.timer = null;
                this.warningCount = 0;
                this.quizCompleted = false;
                this.isAnswered = false;
                this.navigationVisible = true;
                this.quizTaken = false; // Track if user has already taken the quiz
                
                this.init();
            }
            
            init() {
                this.setupEventListeners();
                this.setupSecurityFeatures();
                this.enterFullscreen();
            }
            
            setupEventListeners() {
                document.getElementById('loginForm').addEventListener('submit', (e) => this.handleLogin(e));
                document.getElementById('startQuizBtn').addEventListener('click', () => this.startQuiz());
                document.getElementById('nextBtn').addEventListener('click', () => this.nextQuestion());
                document.getElementById('prevBtn').addEventListener('click', () => this.prevQuestion());
                document.getElementById('warningOkBtn').addEventListener('click', () => this.closeWarning());
                document.getElementById('toggleNavBtn').addEventListener('click', () => this.toggleNavigation());
                document.getElementById('closeNavBtn').addEventListener('click', () => this.hideNavigation());
            }
            
            setupSecurityFeatures() {
                // Anti screenshot
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'PrintScreen' || 
                        (e.ctrlKey && e.shiftKey && e.key === 'I') ||
                        (e.ctrlKey && e.shiftKey && e.key === 'J') ||
                        (e.ctrlKey && e.key === 'u') ||
                        (e.key === 'F12')) {
                        e.preventDefault();
                        this.showWarning('Screenshot dan developer tools tidak diizinkan!');
                    }
                });
                
                // Anti right click
                document.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    this.showWarning('Klik kanan tidak diizinkan!');
                });
                
                // Tab switching detection
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && document.getElementById('quizScreen').style.display !== 'none') {
                        this.showWarning('Jangan beralih tab selama kuis berlangsung!');
                    }
                });
                
                // Window focus detection
                window.addEventListener('blur', () => {
                    if (document.getElementById('quizScreen').style.display !== 'none') {
                        this.showWarning('Jangan beralih aplikasi selama kuis berlangsung!');
                    }
                });
            }
            
            enterFullscreen() {
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                }
            }
            
            async handleLogin(e) {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                try {
                    const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vSXp8px6BoP8tsTKMbk7hMvX96h9O5MPS52OLnDm3JQ-1WpXWIS7e94-K-eAxtVHvONK_DEmoR_yka0/pub?gid=1934144092&single=true&output=csv');
                    const csvData = await response.text();
                    const users = this.parseCSV(csvData);
                    
                    const user = users.find(u => u.username === username && u.password === password);
                    
                    if (user) {
                        this.currentUser = user;
                        // Check if user has already taken the quiz
                        await this.checkQuizStatus();
                    } else {
                        document.getElementById('loginError').textContent = 'Username atau password salah!';
                        document.getElementById('loginError').classList.remove('hidden');
                    }
                } catch (error) {
                    document.getElementById('loginError').textContent = 'Gagal memuat data login!';
                    document.getElementById('loginError').classList.remove('hidden');
                }
            }
            
            async checkQuizStatus() {
                try {
                    // Check if user has already submitted results
                    const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vSXp8px6BoP8tsTKMbk7hMvX96h9O5MPS52OLnDm3JQ-1WpXWIS7e94-K-eAxtVHvONK_DEmoR_yka0/pub?gid=0&single=true&output=csv');
                    const csvData = await response.text();
                    const results = this.parseCSV(csvData);
                    
                    const existingResult = results.find(r => r.username === this.currentUser.username);
                    
                    if (existingResult) {
                        this.quizTaken = true;
                        this.showQuizAlreadyTaken(existingResult);
                    } else {
                        this.showProfile();
                    }
                } catch (error) {
                    // If can't check, allow to proceed
                    this.showProfile();
                }
            }
            
            showQuizAlreadyTaken(result) {
                document.getElementById('loginScreen').classList.add('hidden');
                
                // Create already taken screen
                const alreadyTakenScreen = document.createElement('div');
                alreadyTakenScreen.id = 'alreadyTakenScreen';
                alreadyTakenScreen.className = 'h-full flex items-center justify-center p-4';
                alreadyTakenScreen.innerHTML = `
                    <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 w-full max-w-md shadow-2xl border border-white/20 bounce-in">
                        <div class="text-center">
                            <div class="text-6xl mb-4">⚠️</div>
                            <h2 class="text-2xl font-bold text-white mb-4">Kuis Sudah Dikerjakan</h2>
                            
                            <div class="bg-white/10 rounded-xl p-6 mb-6">
                                <p class="text-blue-200 text-sm mb-2">Nama: ${this.currentUser.nama}</p>
                                <p class="text-blue-200 text-sm mb-2">Kelas: ${this.currentUser.kelas}</p>
                                <p class="text-blue-200 text-sm mb-4">Status: Sudah mengerjakan kuis</p>
                                <div class="border-t border-white/20 pt-4">
                                    <p class="text-white font-semibold">Skor Anda: ${result.score || 'Tidak tersedia'}</p>
                                </div>
                            </div>
                            
                            <p class="text-yellow-200 text-sm mb-6">
                                Anda sudah mengerjakan kuis ini sebelumnya. Setiap peserta hanya diperbolehkan mengerjakan kuis satu kali.
                            </p>
                            
                            <button onclick="location.reload()" 
                                    class="w-full bg-gradient-to-r from-gray-500 to-gray-600 text-white py-3 px-6 rounded-lg font-semibold hover:from-gray-600 hover:to-gray-700 transition-all duration-200">
                                Kembali ke Login
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(alreadyTakenScreen);
            }
            
            showProfile() {
                document.getElementById('profileAbsen').textContent = this.currentUser.absen;
                document.getElementById('profileNama').textContent = this.currentUser.nama;
                document.getElementById('profileKelas').textContent = this.currentUser.kelas;
                
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('profileScreen').classList.remove('hidden');
            }
            
            async startQuiz() {
                // Double check if quiz was already taken
                if (this.quizTaken) {
                    alert('Anda sudah mengerjakan kuis ini sebelumnya!');
                    return;
                }
                
                try {
                    const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vS6MUHUUMK-sG6H063aooPSe7p1hol73KsFMfBBmzTLHFGs33oiuoGpMZd66lRQNvNcVSx1l9P8KgIe/pub?gid=0&single=true&output=csv');
                    const csvData = await response.text();
                    this.questions = this.parseQuestions(csvData);
                    
                    // Mark that quiz is being taken
                    this.quizTaken = true;
                    
                    document.getElementById('profileScreen').classList.add('hidden');
                    document.getElementById('quizScreen').classList.remove('hidden');
                    
                    document.getElementById('totalQuestions').textContent = this.questions.length;
                    this.createQuestionNavigation();
                    this.startTimer();
                    this.showQuestion();
                } catch (error) {
                    alert('Gagal memuat soal kuis!');
                }
            }
            
            parseCSV(csvData) {
                const lines = csvData.split('\n');
                const result = [];
                
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line) {
                        const columns = this.parseCSVLine(line);
                        if (columns.length >= 4) {
                            result.push({
                                username: columns[0],
                                password: columns[1],
                                absen: columns[2],
                                nama: columns[3],
                                kelas: columns[4] || ''
                            });
                        }
                    }
                }
                
                return result;
            }
            
            parseQuestions(csvData) {
                const lines = csvData.split('\n');
                const result = [];
                
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line) {
                        const columns = this.parseCSVLine(line);
                        if (columns.length >= 7) {
                            result.push({
                                question: columns[0],
                                optionA: columns[1],
                                optionB: columns[2],
                                optionC: columns[3],
                                optionD: columns[4],
                                correctAnswer: columns[5],
                                explanation: columns[6],
                                image: columns[7] || ''
                            });
                        }
                    }
                }
                
                return result;
            }
            
            parseCSVLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                result.push(current.trim());
                return result;
            }
            
            createQuestionNavigation() {
                const navigationContainer = document.getElementById('questionNavigation');
                navigationContainer.innerHTML = '';
                
                for (let i = 0; i < this.questions.length; i++) {
                    const button = document.createElement('button');
                    button.className = 'w-8 h-8 rounded text-xs font-semibold transition-all duration-200 hover:scale-110';
                    button.textContent = i + 1;
                    button.addEventListener('click', () => this.goToQuestion(i));
                    navigationContainer.appendChild(button);
                }
                
                this.updateQuestionNavigation();
            }
            
            updateQuestionNavigation() {
                const buttons = document.querySelectorAll('#questionNavigation button');
                
                buttons.forEach((button, index) => {
                    // Reset classes
                    button.className = 'w-8 h-8 rounded text-xs font-semibold transition-all duration-200 hover:scale-110';
                    
                    if (index === this.currentQuestionIndex) {
                        // Current question - blue
                        button.classList.add('bg-blue-500', 'text-white', 'ring-2', 'ring-blue-300');
                    } else if (this.answers[index]) {
                        // Answered question
                        if (this.answers[index].correct) {
                            // Correct answer - green
                            button.classList.add('bg-green-500', 'text-white');
                        } else {
                            // Wrong answer - red
                            button.classList.add('bg-red-500', 'text-white');
                        }
                    } else {
                        // Unanswered question - gray
                        button.classList.add('bg-white/20', 'text-white', 'hover:bg-white/30');
                    }
                });
            }
            
            goToQuestion(questionIndex) {
                if (questionIndex >= 0 && questionIndex < this.questions.length) {
                    this.currentQuestionIndex = questionIndex;
                    this.showQuestion();
                }
            }

            showQuestion() {
                const question = this.questions[this.currentQuestionIndex];
                this.isAnswered = this.answers[this.currentQuestionIndex] ? true : false;
                
                document.getElementById('currentQuestion').textContent = this.currentQuestionIndex + 1;
                document.getElementById('questionText').textContent = question.question;
                
                // Show image if available
                if (question.image && question.image.trim()) {
                    document.getElementById('questionImg').src = question.image;
                    document.getElementById('questionImage').classList.remove('hidden');
                } else {
                    document.getElementById('questionImage').classList.add('hidden');
                }
                
                // Create options
                const optionsContainer = document.getElementById('optionsContainer');
                optionsContainer.innerHTML = '';
                
                const options = [
                    { key: 'A', text: question.optionA },
                    { key: 'B', text: question.optionB },
                    { key: 'C', text: question.optionC },
                    { key: 'D', text: question.optionD }
                ];
                
                options.forEach(option => {
                    const button = document.createElement('button');
                    button.className = 'w-full text-left p-4 bg-white/10 hover:bg-white/20 border border-white/30 rounded-lg text-white transition-all duration-200 hover:scale-105';
                    button.innerHTML = `<span class="font-semibold">${option.key}.</span> ${option.text}`;
                    
                    // If this question was already answered, show the previous selection
                    if (this.answers[this.currentQuestionIndex]) {
                        const answer = this.answers[this.currentQuestionIndex];
                        if (answer.selected === option.key) {
                            button.style.backgroundColor = answer.correct ? 'rgb(34, 197, 94)' : 'rgb(239, 68, 68)';
                        } else if (option.key === question.correctAnswer && !answer.correct) {
                            button.style.backgroundColor = 'rgb(34, 197, 94)';
                        }
                        button.style.pointerEvents = 'none'; // Disable clicking on answered questions
                    } else {
                        button.addEventListener('click', () => this.selectAnswer(option.key, button));
                    }
                    
                    optionsContainer.appendChild(button);
                });
                
                // Show/hide feedback based on whether question was answered
                if (this.answers[this.currentQuestionIndex]) {
                    this.showPreviousFeedback();
                } else {
                    document.getElementById('feedback').classList.add('hidden');
                }
                
                // Update progress
                const progress = ((this.currentQuestionIndex + 1) / this.questions.length) * 100;
                document.getElementById('progressBar').style.width = progress + '%';
                
                // Update navigation buttons
                const prevBtn = document.getElementById('prevBtn');
                const nextBtn = document.getElementById('nextBtn');
                
                // Sembunyikan tombol sebelumnya
                prevBtn.style.display = 'none';
                
                nextBtn.textContent = this.currentQuestionIndex === this.questions.length - 1 ? 'Selesai' : 'Selanjutnya →';
                
                // Update question navigation
                this.updateQuestionNavigation();
            }
            
            showPreviousFeedback() {
                const question = this.questions[this.currentQuestionIndex];
                const answer = this.answers[this.currentQuestionIndex];
                const feedback = document.getElementById('feedback');
                const feedbackContent = document.getElementById('feedbackContent');
                
                feedbackContent.className = `p-4 rounded-lg ${answer.correct ? 'bg-green-600' : 'bg-red-600'}`;
                feedbackContent.innerHTML = `
                    <div class="flex items-center mb-2">
                        <span class="text-2xl mr-2">${answer.correct ? '✅' : '❌'}</span>
                        <span class="font-semibold">${answer.correct ? 'Benar!' : 'Salah!'}</span>
                    </div>
                    ${!answer.correct ? `<p class="mb-2"><strong>Jawaban yang benar:</strong> ${question.correctAnswer}</p>` : ''}
                    <p><strong>Penjelasan:</strong> ${question.explanation}</p>
                `;
                
                feedback.classList.remove('hidden');
            }
            
            selectAnswer(selectedKey, buttonElement) {
                if (this.isAnswered) return;
                
                this.isAnswered = true;
                const question = this.questions[this.currentQuestionIndex];
                const isCorrect = selectedKey === question.correctAnswer;
                
                // Store answer
                this.answers[this.currentQuestionIndex] = {
                    selected: selectedKey,
                    correct: isCorrect
                };
                
                // Update score
                if (isCorrect) {
                    this.score += 10;
                    document.getElementById('currentScore').textContent = this.score;
                }
                
                // Show feedback with animation
                this.showFeedback(isCorrect, question, buttonElement);
            }
            
            showFeedback(isCorrect, question, selectedButton) {
                const feedback = document.getElementById('feedback');
                const feedbackContent = document.getElementById('feedbackContent');
                
                // Animate selected button
                if (isCorrect) {
                    selectedButton.classList.add('pulse-success');
                    selectedButton.style.backgroundColor = 'rgb(34, 197, 94)';
                    this.showSuccessAnimation();
                } else {
                    selectedButton.classList.add('pulse-error', 'shake');
                    selectedButton.style.backgroundColor = 'rgb(239, 68, 68)';
                    
                    // Highlight correct answer
                    const options = document.querySelectorAll('#optionsContainer button');
                    options.forEach(btn => {
                        if (btn.textContent.startsWith(question.correctAnswer + '.')) {
                            btn.style.backgroundColor = 'rgb(34, 197, 94)';
                            btn.classList.add('pulse-success');
                        }
                    });
                }
                
                // Show feedback message
                feedbackContent.className = `p-4 rounded-lg ${isCorrect ? 'bg-green-600' : 'bg-red-600'}`;
                feedbackContent.innerHTML = `
                    <div class="flex items-center mb-2">
                        <span class="text-2xl mr-2">${isCorrect ? '✅' : '❌'}</span>
                        <span class="font-semibold">${isCorrect ? 'Benar!' : 'Salah!'}</span>
                    </div>
                    ${!isCorrect ? `<p class="mb-2"><strong>Jawaban yang benar:</strong> ${question.correctAnswer}</p>` : ''}
                    <p><strong>Penjelasan:</strong> ${question.explanation}</p>
                `;
                
                feedback.classList.remove('hidden');
                feedback.classList.add('slide-in');
                
                // Update navigation immediately after answering
                this.updateQuestionNavigation();
                
                // Auto advance after 3 seconds
                setTimeout(() => {
                    if (this.currentQuestionIndex < this.questions.length - 1) {
                        this.nextQuestion();
                    }
                }, 3000);
            }
            
            showSuccessAnimation() {
                // Create floating success indicator
                const indicator = document.createElement('div');
                indicator.textContent = '+10';
                indicator.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-4xl font-bold text-green-400 pointer-events-none z-50';
                indicator.style.animation = 'fadeIn 0.5s ease-in-out, slideIn 0.5s ease-out';
                document.body.appendChild(indicator);
                
                setTimeout(() => {
                    indicator.remove();
                }, 1000);
            }
            
            nextQuestion() {
                if (this.currentQuestionIndex < this.questions.length - 1) {
                    this.currentQuestionIndex++;
                    this.showQuestion();
                } else {
                    this.finishQuiz();
                }
            }
            
            prevQuestion() {
                // Tombol sebelumnya dinonaktifkan untuk mencegah kembali ke soal sebelumnya
                return;
            }
            
            async finishQuiz() {
                this.quizCompleted = true;
                clearInterval(this.timer);
                
                const totalQuestions = this.questions.length;
                const correctAnswers = this.answers.filter(a => a && a.correct).length;
                const percentage = Math.round((correctAnswers / totalQuestions) * 100);
                
                // Save results
                await this.saveResults(this.score);
                
                // Show results
                document.getElementById('quizScreen').classList.add('hidden');
                document.getElementById('resultScreen').classList.remove('hidden');
                
                document.getElementById('finalScore').textContent = this.score;
                document.getElementById('finalPercentage').textContent = percentage + '%';
                
                // Show appropriate message and animation
                this.showResultMessage(percentage);
                
                // Countdown to return to login
                this.startReturnCountdown();
            }
            
            showResultMessage(percentage) {
                const messageEl = document.getElementById('scoreMessage');
                const iconEl = document.getElementById('resultIcon');
                
                if (percentage >= 90) {
                    messageEl.textContent = '🌟 Luar biasa! Nilai sempurna!';
                    iconEl.textContent = '🏆';
                    this.showConfetti();
                } else if (percentage >= 80) {
                    messageEl.textContent = '👏 Bagus sekali! Pertahankan!';
                    iconEl.textContent = '🎉';
                } else if (percentage >= 70) {
                    messageEl.textContent = '👍 Cukup baik, terus belajar!';
                    iconEl.textContent = '😊';
                } else if (percentage >= 60) {
                    messageEl.textContent = '📚 Perlu belajar lebih giat lagi!';
                    iconEl.textContent = '😐';
                } else {
                    messageEl.textContent = '💪 Jangan menyerah, terus berlatih!';
                    iconEl.textContent = '😔';
                }
            }
            
            showConfetti() {
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
                
                setTimeout(() => {
                    confetti({
                        particleCount: 50,
                        angle: 60,
                        spread: 55,
                        origin: { x: 0 }
                    });
                }, 250);
                
                setTimeout(() => {
                    confetti({
                        particleCount: 50,
                        angle: 120,
                        spread: 55,
                        origin: { x: 1 }
                    });
                }, 400);
            }
            
            async saveResults(score) {
                try {
                    const formData = new FormData();
                    formData.append('NIS', this.currentUser.username);
                    formData.append('Absen', this.currentUser.absen);
                    formData.append('NamaLengkap', this.currentUser.nama);
                    formData.append('Kelas', this.currentUser.kelas);
                    formData.append('HasilNilai', score);
                    
                    await fetch('https://script.google.com/macros/s/AKfycbyy0FYm7Djd8RoyCjGKgXqCAJtO2qpmT4EI7CoiToseDfF-M45TlgG1yng7cJH-7G8pgw/exec', {
                        method: 'POST',
                        body: formData
                    });
                } catch (error) {
                    console.error('Gagal menyimpan hasil:', error);
                }
            }
            
            startReturnCountdown() {
                let countdown = 2;
                const countdownEl = document.getElementById('countdown');
                
                const interval = setInterval(() => {
                    countdown--;
                    countdownEl.textContent = countdown;
                    
                    if (countdown <= 0) {
                        clearInterval(interval);
                        this.returnToLogin();
                    }
                }, 1000);
            }
            
            returnToLogin() {
                // Reset all data
                this.currentUser = null;
                this.questions = [];
                this.currentQuestionIndex = 0;
                this.score = 0;
                this.answers = [];
                this.timeLeft = 3600;
                this.warningCount = 0;
                this.quizCompleted = false;
                this.navigationVisible = true;
                this.quizTaken = false;
                
                // Reset UI
                document.getElementById('resultScreen').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('loginForm').reset();
                document.getElementById('loginError').classList.add('hidden');
                document.getElementById('currentScore').textContent = '0';
                document.getElementById('warningCount').textContent = '0';
                
                // Remove already taken screen if exists
                const alreadyTakenScreen = document.getElementById('alreadyTakenScreen');
                if (alreadyTakenScreen) {
                    alreadyTakenScreen.remove();
                }
            }
            
            startTimer() {
                this.timer = setInterval(() => {
                    this.timeLeft--;
                    
                    const minutes = Math.floor(this.timeLeft / 60);
                    const seconds = this.timeLeft % 60;
                    const timerEl = document.getElementById('timer');
                    
                    timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    
                    // Warning when time is running out
                    if (this.timeLeft <= 300) { // 5 minutes
                        timerEl.classList.add('timer-warning');
                    }
                    
                    if (this.timeLeft <= 0) {
                        this.finishQuiz();
                    }
                }, 1000);
            }
            
            showWarning(message) {
                if (this.quizCompleted) return;
                
                this.warningCount++;
                document.getElementById('warningCount').textContent = this.warningCount;
                document.getElementById('warningMessage').textContent = message;
                document.getElementById('warningModalCount').textContent = this.warningCount;
                document.getElementById('warningModal').classList.remove('hidden');
                
                if (this.warningCount >= 3) {
                    setTimeout(() => {
                        alert('Kuis dihentikan karena terlalu banyak pelanggaran!');
                        this.finishQuiz();
                    }, 2000);
                }
            }
            
            closeWarning() {
                document.getElementById('warningModal').classList.add('hidden');
            }
            
            toggleNavigation() {
                if (this.navigationVisible) {
                    this.hideNavigation();
                } else {
                    this.showNavigation();
                }
            }
            
            hideNavigation() {
                const sidebar = document.getElementById('navigationSidebar');
                sidebar.style.width = '0';
                sidebar.style.overflow = 'hidden';
                sidebar.style.opacity = '0';
                this.navigationVisible = false;
                
                document.getElementById('toggleNavBtn').textContent = '📋 Tampilkan Menu';
            }
            
            showNavigation() {
                const sidebar = document.getElementById('navigationSidebar');
                sidebar.style.width = '16rem'; // w-64 = 16rem
                sidebar.style.overflow = 'visible';
                sidebar.style.opacity = '1';
                this.navigationVisible = true;
                
                document.getElementById('toggleNavBtn').textContent = '📋 Menu';
            }
        }
        
        // Initialize the quiz app
        const quizApp = new QuizApp();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99012041a1160d7e',t:'MTc2MDcxODA1NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>

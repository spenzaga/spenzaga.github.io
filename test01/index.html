<!DOCTYPE html>
<html lang="id" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kuis Interaktif</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        .correct-answer {
            animation: correctPulse 0.6s ease-in-out;
        }
        
        .wrong-answer {
            animation: wrongShake 0.6s ease-in-out;
        }
        
        .progress-fill {
            transition: width 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes correctPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); background-color: #10b981; }
            100% { transform: scale(1); }
        }
        
        @keyframes wrongShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        
        .navigation-toggle {
            transition: transform 0.3s ease;
        }
        
        .navigation-panel {
            transition: transform 0.3s ease;
        }
        
        .question-nav-btn {
            transition: all 0.2s ease;
        }
        
        .timer-warning {
            animation: timerBlink 1s infinite;
        }
        
        @keyframes timerBlink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.5; }
        }
        
        .security-warning {
            animation: securityAlert 0.5s ease-in-out;
        }
        
        @keyframes securityAlert {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); background-color: #ef4444; }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body class="h-full bg-gradient-to-br from-blue-900 via-purple-900 to-indigo-900 font-sans overflow-hidden">
    <!-- Login Screen -->
    <div id="loginScreen" class="h-full flex items-center justify-center fade-in">
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 w-96 shadow-2xl border border-white/20">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-white mb-2">üéØ Kuis Interaktif</h1>
                <p class="text-blue-200">Masuk untuk memulai kuis</p>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label for="username" class="block text-sm font-medium text-white mb-2">Username</label>
                    <input type="text" id="username" required 
                           class="w-full px-4 py-3 bg-white/20 border border-white/30 rounded-lg text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent">
                </div>
                
                <div>
                    <label for="password" class="block text-sm font-medium text-white mb-2">Password</label>
                    <input type="password" id="password" required 
                           class="w-full px-4 py-3 bg-white/20 border border-white/30 rounded-lg text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent">
                </div>
                
                <button type="submit" 
                        class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 rounded-lg font-semibold hover:from-blue-600 hover:to-purple-700 transform hover:scale-105 transition-all duration-200 shadow-lg">
                    Masuk
                </button>
            </form>
            
            <div id="loginError" class="mt-4 text-red-300 text-sm text-center hidden"></div>
            <div id="loginLoading" class="mt-4 text-blue-200 text-sm text-center hidden">
                <div class="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                Memuat data...
            </div>
        </div>
    </div>

    <!-- Profile Screen -->
    <div id="profileScreen" class="h-full flex items-center justify-center hidden">
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 w-96 shadow-2xl border border-white/20 slide-in">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-r from-blue-400 to-purple-500 rounded-full mx-auto mb-4 flex items-center justify-center text-2xl">
                    üë§
                </div>
                <h2 class="text-2xl font-bold text-white mb-2">Profil Peserta</h2>
            </div>
            
            <div class="space-y-4 mb-8">
                <div class="bg-white/10 rounded-lg p-4">
                    <label class="block text-sm text-blue-200 mb-1">No. Absen</label>
                    <div id="profileAbsen" class="text-white font-semibold text-lg"></div>
                </div>
                
                <div class="bg-white/10 rounded-lg p-4">
                    <label class="block text-sm text-blue-200 mb-1">Nama Lengkap</label>
                    <div id="profileNama" class="text-white font-semibold text-lg"></div>
                </div>
                
                <div class="bg-white/10 rounded-lg p-4">
                    <label class="block text-sm text-blue-200 mb-1">Kelas</label>
                    <div id="profileKelas" class="text-white font-semibold text-lg"></div>
                </div>
            </div>
            
            <button id="startQuizBtn" 
                    class="w-full bg-gradient-to-r from-green-500 to-blue-600 text-white py-3 rounded-lg font-semibold hover:from-green-600 hover:to-blue-700 transform hover:scale-105 transition-all duration-200 shadow-lg">
                üöÄ Mulai Kuis
            </button>
        </div>
    </div>

    <!-- Quiz Screen -->
    <div id="quizScreen" class="h-full hidden">
        <!-- Header -->
        <header class="bg-white/10 backdrop-blur-lg border-b border-white/20 p-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <button id="navToggle" class="text-white hover:text-blue-300 transition-colors navigation-toggle">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                    <h1 class="text-xl font-bold text-white">Kuis Interaktif</h1>
                </div>
                
                <div class="flex items-center space-x-6">
                    <div class="text-white">
                        <span class="text-sm text-blue-200">Soal</span>
                        <span id="currentQuestion" class="font-bold ml-1">1</span>
                        <span class="text-blue-200">dari</span>
                        <span id="totalQuestions" class="font-bold">0</span>
                    </div>
                    
                    <div id="timer" class="bg-red-500/20 px-4 py-2 rounded-lg border border-red-400/30">
                        <span class="text-red-200 text-sm">‚è∞</span>
                        <span id="timeLeft" class="text-white font-mono font-bold ml-2">50:00</span>
                    </div>
                    
                    <div class="text-white">
                        <span class="text-sm text-blue-200">Skor:</span>
                        <span id="currentScore" class="font-bold ml-1">0</span>
                    </div>
                </div>
            </div>
            
            <!-- Progress Bar -->
            <div class="mt-4">
                <div class="bg-white/20 rounded-full h-2">
                    <div id="progressBar" class="bg-gradient-to-r from-blue-400 to-purple-500 h-2 rounded-full progress-fill" style="width: 0%"></div>
                </div>
            </div>
        </header>

        <!-- Navigation Panel -->
        <div id="navigationPanel" class="fixed left-0 top-0 h-full w-80 bg-black/50 backdrop-blur-lg border-r border-white/20 transform -translate-x-full navigation-panel z-40">
            <div class="p-6">
                <h3 class="text-white font-bold text-lg mb-4">Navigasi Soal</h3>
                <div id="questionNavGrid" class="grid grid-cols-5 gap-2"></div>
            </div>
        </div>

        <!-- Main Content -->
        <main class="flex-1 p-6 overflow-y-auto" style="height: calc(100% - 120px);">
            <div class="max-w-4xl mx-auto">
                <!-- Question Card -->
                <div id="questionCard" class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 shadow-2xl border border-white/20 mb-6">
                    <div id="questionText" class="text-white text-xl mb-6 leading-relaxed"></div>
                    <div id="questionImage" class="mb-6 hidden">
                        <img id="questionImg" class="max-w-full h-auto rounded-lg shadow-lg" alt="Gambar soal">
                    </div>
                    
                    <div id="optionsContainer" class="space-y-4"></div>
                    
                    <div id="feedbackContainer" class="mt-6 hidden">
                        <div id="feedbackMessage" class="p-4 rounded-lg mb-4"></div>
                        <div id="explanationText" class="text-blue-100 bg-blue-900/30 p-4 rounded-lg"></div>
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div class="flex justify-between">
                    <button id="prevBtn" 
                            class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-semibold transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                        ‚Üê Sebelumnya
                    </button>
                    
                    <button id="nextBtn" 
                            class="bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 text-white px-6 py-3 rounded-lg font-semibold transition-all duration-200">
                        Selanjutnya ‚Üí
                    </button>
                    
                    <button id="finishBtn" 
                            class="bg-gradient-to-r from-green-500 to-blue-600 hover:from-green-600 hover:to-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition-all duration-200 hidden">
                        üèÅ Selesai
                    </button>
                </div>
            </div>
        </main>

        <!-- Security Warning -->
        <div id="securityWarning" class="fixed top-4 right-4 bg-red-500 text-white p-4 rounded-lg shadow-lg hidden z-50 security-warning">
            <div class="flex items-center">
                <span class="text-xl mr-2">‚ö†Ô∏è</span>
                <div>
                    <div class="font-bold">Peringatan Keamanan!</div>
                    <div class="text-sm" id="warningText"></div>
                    <div class="text-xs mt-1">Peringatan: <span id="warningCount">0</span>/3</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Screen -->
    <div id="resultsScreen" class="h-full flex items-center justify-center hidden">
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-8 w-96 shadow-2xl border border-white/20 text-center slide-in">
            <div id="resultIcon" class="text-6xl mb-4"></div>
            <h2 class="text-3xl font-bold text-white mb-4">Kuis Selesai!</h2>
            
            <div class="bg-white/10 rounded-lg p-6 mb-6">
                <div class="text-4xl font-bold text-white mb-2" id="finalScore">0</div>
                <div class="text-blue-200">Skor Akhir</div>
            </div>
            
            <div id="resultMessage" class="text-white mb-6"></div>
            
            <div class="text-sm text-blue-200">
                Kembali ke login dalam <span id="countdown">2</span> detik...
            </div>
        </div>
    </div>

    <script>
        class QuizApp {
            constructor() {
                this.currentUser = null;
                this.questions = [];
                this.userAnswers = [];
                this.currentQuestionIndex = 0;
                this.score = 0;
                this.timeLeft = 50 * 60; // 50 minutes in seconds
                this.timer = null;
                this.warningCount = 0;
                this.quizCompleted = false;
                this.navigationVisible = false;
                
                this.initializeEventListeners();
                this.initializeSecurity();
                this.enterFullscreen();
            }

            initializeEventListeners() {
                // Login form
                document.getElementById('loginForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleLogin();
                });

                // Start quiz button
                document.getElementById('startQuizBtn').addEventListener('click', () => {
                    this.startQuiz();
                });

                // Navigation toggle
                document.getElementById('navToggle').addEventListener('click', () => {
                    this.toggleNavigation();
                });

                // Quiz navigation buttons
                document.getElementById('prevBtn').addEventListener('click', () => {
                    this.previousQuestion();
                });

                document.getElementById('nextBtn').addEventListener('click', () => {
                    this.nextQuestion();
                });

                document.getElementById('finishBtn').addEventListener('click', () => {
                    this.finishQuiz();
                });
            }

            initializeSecurity() {
                // Disable right-click
                document.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    this.showSecurityWarning('Klik kanan dinonaktifkan!');
                });

                // Disable keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    // Disable F12, Ctrl+Shift+I, Ctrl+U, Ctrl+S, etc.
                    if (e.key === 'F12' || 
                        (e.ctrlKey && (e.shiftKey && e.key === 'I')) ||
                        (e.ctrlKey && e.key === 'u') ||
                        (e.ctrlKey && e.key === 's') ||
                        (e.ctrlKey && e.shiftKey && e.key === 'C') ||
                        e.key === 'PrintScreen') {
                        e.preventDefault();
                        this.showSecurityWarning('Shortcut keyboard diblokir!');
                    }
                });

                // Detect tab switching
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && !this.quizCompleted) {
                        this.showSecurityWarning('Jangan berpindah tab!');
                    }
                });

                // Disable text selection and drag
                document.addEventListener('selectstart', (e) => {
                    e.preventDefault();
                });

                document.addEventListener('dragstart', (e) => {
                    e.preventDefault();
                });
            }

            enterFullscreen() {
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen();
                }
            }

            showSecurityWarning(message) {
                if (this.quizCompleted) return;
                
                this.warningCount++;
                const warningEl = document.getElementById('securityWarning');
                const warningTextEl = document.getElementById('warningText');
                const warningCountEl = document.getElementById('warningCount');
                
                warningTextEl.textContent = message;
                warningCountEl.textContent = this.warningCount;
                warningEl.classList.remove('hidden');
                
                setTimeout(() => {
                    warningEl.classList.add('hidden');
                }, 3000);
                
                if (this.warningCount >= 3) {
                    alert('Terlalu banyak pelanggaran! Kuis dihentikan.');
                    this.finishQuiz();
                }
            }

            async handleLogin() {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const errorEl = document.getElementById('loginError');
                const loadingEl = document.getElementById('loginLoading');
                
                errorEl.classList.add('hidden');
                loadingEl.classList.remove('hidden');
                
                try {
                    // Check if user already completed quiz
                    const hasCompleted = await this.checkIfUserCompleted(username);
                    if (hasCompleted) {
                        errorEl.innerHTML = '‚ö†Ô∏è Anda sudah menyelesaikan kuis ini sebelumnya!<br><small>Setiap peserta hanya dapat mengerjakan kuis satu kali.</small>';
                        errorEl.classList.remove('hidden');
                        loadingEl.classList.add('hidden');
                        return;
                    }
                    
                    const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vSXp8px6BoP8tsTKMbk7hMvX96h9O5MPS52OLnDm3JQ-1WpXWIS7e94-K-eAxtVHvONK_DEmoR_yka0/pub?gid=1934144092&single=true&output=csv');
                    const csvText = await response.text();
                    const users = this.parseCSV(csvText);
                    
                    const user = users.find(u => u.username === username && u.password === password);
                    
                    if (user) {
                        this.currentUser = user;
                        this.showProfile();
                    } else {
                        errorEl.textContent = 'Username atau password salah!';
                        errorEl.classList.remove('hidden');
                    }
                } catch (error) {
                    errorEl.textContent = 'Gagal memuat data login!';
                    errorEl.classList.remove('hidden');
                }
                
                loadingEl.classList.add('hidden');
            }

            parseCSV(csvText) {
                const lines = csvText.trim().split('\n');
                const users = [];
                
                for (let i = 1; i < lines.length; i++) { // Skip header
                    const columns = lines[i].split(',');
                    if (columns.length >= 5) {
                        users.push({
                            username: columns[0].trim(),
                            password: columns[1].trim(),
                            absen: columns[2].trim(),
                            nama: columns[3].trim(),
                            kelas: columns[4].trim()
                        });
                    }
                }
                
                return users;
            }

            showProfile() {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('profileScreen').classList.remove('hidden');
                
                document.getElementById('profileAbsen').textContent = this.currentUser.absen;
                document.getElementById('profileNama').textContent = this.currentUser.nama;
                document.getElementById('profileKelas').textContent = this.currentUser.kelas;
            }

            async startQuiz() {
                try {
                    const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vS6MUHUUMK-sG6H063aooPSe7p1hol73KsFMfBBmzTLHFGs33oiuoGpMZd66lRQNvNcVSx1l9P8KgIe/pub?gid=0&single=true&output=csv');
                    const csvText = await response.text();
                    this.questions = this.parseQuestions(csvText);
                    
                    if (this.questions.length === 0) {
                        alert('Tidak ada soal yang tersedia!');
                        return;
                    }
                    
                    this.userAnswers = new Array(this.questions.length).fill(null);
                    
                    document.getElementById('profileScreen').classList.add('hidden');
                    document.getElementById('quizScreen').classList.remove('hidden');
                    
                    this.setupQuiz();
                    this.startTimer();
                    this.displayQuestion();
                } catch (error) {
                    alert('Gagal memuat soal kuis!');
                }
            }

            parseQuestions(csvText) {
                const lines = csvText.trim().split('\n');
                const questions = [];
                
                for (let i = 1; i < lines.length; i++) { // Skip header
                    const columns = lines[i].split(',');
                    if (columns.length >= 7) {
                        questions.push({
                            question: columns[0].trim(),
                            options: [
                                columns[1].trim(),
                                columns[2].trim(),
                                columns[3].trim(),
                                columns[4].trim()
                            ],
                            correctAnswer: columns[5].trim().toUpperCase(),
                            explanation: columns[6].trim(),
                            image: columns[7] ? columns[7].trim() : null
                        });
                    }
                }
                
                return questions;
            }

            setupQuiz() {
                document.getElementById('totalQuestions').textContent = this.questions.length;
                this.updateProgress();
                this.createNavigationGrid();
            }

            createNavigationGrid() {
                const grid = document.getElementById('questionNavGrid');
                grid.innerHTML = '';
                
                for (let i = 0; i < this.questions.length; i++) {
                    const btn = document.createElement('button');
                    btn.textContent = i + 1;
                    btn.className = 'question-nav-btn w-10 h-10 rounded-lg border border-white/30 text-white hover:bg-white/20 transition-all';
                    btn.addEventListener('click', () => {
                        this.currentQuestionIndex = i;
                        this.displayQuestion();
                        this.toggleNavigation();
                    });
                    grid.appendChild(btn);
                }
            }

            updateNavigationGrid() {
                const buttons = document.querySelectorAll('.question-nav-btn');
                buttons.forEach((btn, index) => {
                    btn.className = 'question-nav-btn w-10 h-10 rounded-lg border transition-all';
                    
                    if (index === this.currentQuestionIndex) {
                        btn.className += ' bg-blue-500 text-white border-blue-400';
                    } else if (this.userAnswers[index] !== null) {
                        btn.className += ' bg-green-500 text-white border-green-400';
                    } else {
                        btn.className += ' border-white/30 text-white hover:bg-white/20';
                    }
                });
            }

            toggleNavigation() {
                this.navigationVisible = !this.navigationVisible;
                const panel = document.getElementById('navigationPanel');
                
                if (this.navigationVisible) {
                    panel.style.transform = 'translateX(0)';
                    this.updateNavigationGrid();
                } else {
                    panel.style.transform = 'translateX(-100%)';
                }
            }

            displayQuestion() {
                const question = this.questions[this.currentQuestionIndex];
                
                document.getElementById('currentQuestion').textContent = this.currentQuestionIndex + 1;
                document.getElementById('questionText').textContent = question.question;
                
                // Handle image
                const imageContainer = document.getElementById('questionImage');
                const imageEl = document.getElementById('questionImg');
                
                if (question.image && question.image !== '') {
                    imageEl.src = question.image;
                    imageEl.onerror = function() {
                        this.src = '';
                        this.alt = 'Gambar gagal dimuat';
                        this.style.display = 'none';
                    };
                    imageContainer.classList.remove('hidden');
                } else {
                    imageContainer.classList.add('hidden');
                }
                
                // Create options
                const container = document.getElementById('optionsContainer');
                container.innerHTML = '';
                
                const letters = ['A', 'B', 'C', 'D'];
                question.options.forEach((option, index) => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'option-item bg-white/10 hover:bg-white/20 border border-white/30 rounded-lg p-4 cursor-pointer transition-all duration-200';
                    
                    const userAnswer = this.userAnswers[this.currentQuestionIndex];
                    if (userAnswer === letters[index]) {
                        optionDiv.className += ' bg-blue-500/50 border-blue-400';
                    }
                    
                    optionDiv.innerHTML = `
                        <div class="flex items-center">
                            <div class="w-8 h-8 rounded-full border-2 border-white/50 flex items-center justify-center mr-4 text-white font-bold">
                                ${letters[index]}
                            </div>
                            <div class="text-white flex-1">${option}</div>
                        </div>
                    `;
                    
                    if (userAnswer === null) {
                        optionDiv.addEventListener('click', () => {
                            this.selectAnswer(letters[index]);
                        });
                    }
                    
                    container.appendChild(optionDiv);
                });
                
                // Update navigation buttons
                document.getElementById('prevBtn').disabled = this.currentQuestionIndex === 0;
                
                const isLastQuestion = this.currentQuestionIndex === this.questions.length - 1;
                document.getElementById('nextBtn').classList.toggle('hidden', isLastQuestion);
                document.getElementById('finishBtn').classList.toggle('hidden', !isLastQuestion);
                
                // Hide feedback
                document.getElementById('feedbackContainer').classList.add('hidden');
                
                this.updateProgress();
            }

            selectAnswer(selectedLetter) {
                if (this.userAnswers[this.currentQuestionIndex] !== null) return;
                
                this.userAnswers[this.currentQuestionIndex] = selectedLetter;
                const question = this.questions[this.currentQuestionIndex];
                const isCorrect = selectedLetter === question.correctAnswer;
                
                if (isCorrect) {
                    this.score += 10;
                    document.getElementById('currentScore').textContent = this.score;
                }
                
                this.showFeedback(isCorrect, question);
                this.updateNavigationGrid();
            }

            showFeedback(isCorrect, question) {
                const container = document.getElementById('feedbackContainer');
                const messageEl = document.getElementById('feedbackMessage');
                const explanationEl = document.getElementById('explanationText');
                
                if (isCorrect) {
                    messageEl.className = 'p-4 rounded-lg mb-4 bg-green-500/20 border border-green-400 text-green-200 correct-answer';
                    messageEl.innerHTML = '‚úÖ <strong>Benar!</strong> Jawaban Anda tepat.';
                } else {
                    messageEl.className = 'p-4 rounded-lg mb-4 bg-red-500/20 border border-red-400 text-red-200 wrong-answer';
                    messageEl.innerHTML = `‚ùå <strong>Salah!</strong> Jawaban yang benar adalah <strong>${question.correctAnswer}</strong>.`;
                }
                
                explanationEl.textContent = question.explanation;
                container.classList.remove('hidden');
                
                // Auto advance after 3 seconds
                setTimeout(() => {
                    if (this.currentQuestionIndex < this.questions.length - 1) {
                        this.nextQuestion();
                    }
                }, 3000);
            }

            nextQuestion() {
                if (this.currentQuestionIndex < this.questions.length - 1) {
                    this.currentQuestionIndex++;
                    this.displayQuestion();
                }
            }

            previousQuestion() {
                if (this.currentQuestionIndex > 0) {
                    this.currentQuestionIndex--;
                    this.displayQuestion();
                }
            }

            updateProgress() {
                const progress = ((this.currentQuestionIndex + 1) / this.questions.length) * 100;
                document.getElementById('progressBar').style.width = `${progress}%`;
            }

            startTimer() {
                this.timer = setInterval(() => {
                    this.timeLeft--;
                    
                    const minutes = Math.floor(this.timeLeft / 60);
                    const seconds = this.timeLeft % 60;
                    const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    
                    document.getElementById('timeLeft').textContent = timeString;
                    
                    // Warning when 5 minutes left
                    if (this.timeLeft <= 300) {
                        document.getElementById('timer').classList.add('timer-warning');
                    }
                    
                    if (this.timeLeft <= 0) {
                        this.finishQuiz();
                    }
                }, 1000);
            }

            async finishQuiz() {
                this.quizCompleted = true;
                clearInterval(this.timer);
                
                // Calculate final score
                const answeredQuestions = this.userAnswers.filter(answer => answer !== null).length;
                const finalScore = Math.round((this.score / (this.questions.length * 10)) * 100);
                
                // Save results
                await this.saveResults(finalScore);
                
                // Show results
                this.showResults(finalScore);
            }

            async checkIfUserCompleted(username) {
                // First check localStorage (immediate check)
                const localCompleted = localStorage.getItem(`quiz_completed_${username}`);
                if (localCompleted === 'true') {
                    return true;
                }
                
                try {
                    // Also check if there's a way to verify from server
                    // For now, we rely on localStorage as the primary method
                    // since we don't have direct read access to the results sheet
                    return false;
                } catch (error) {
                    console.error('Error checking completion status:', error);
                    return false;
                }
            }

            async saveResults(finalScore) {
                try {
                    const formData = new FormData();
                    formData.append('NIS', this.currentUser.username);
                    formData.append('Absen', this.currentUser.absen);
                    formData.append('NamaLengkap', this.currentUser.nama);
                    formData.append('Kelas', this.currentUser.kelas);
                    formData.append('HasilNilai', finalScore);
                    
                    await fetch('https://script.google.com/macros/s/AKfycbyy0FYm7Djd8RoyCjGKgXqCAJtO2qpmT4EI7CoiToseDfF-M45TlgG1yng7cJH-7G8pgw/exec', {
                        method: 'POST',
                        body: formData
                    });
                    
                    // Mark as completed in localStorage as backup
                    localStorage.setItem(`quiz_completed_${this.currentUser.username}`, 'true');
                } catch (error) {
                    console.error('Gagal menyimpan hasil:', error);
                }
            }

            showResults(finalScore) {
                document.getElementById('quizScreen').classList.add('hidden');
                document.getElementById('resultsScreen').classList.remove('hidden');
                
                document.getElementById('finalScore').textContent = finalScore;
                
                let icon, message;
                if (finalScore >= 90) {
                    icon = 'üèÜ';
                    message = 'Luar biasa! Prestasi yang sangat membanggakan!';
                    this.showConfetti();
                } else if (finalScore >= 80) {
                    icon = 'ü•á';
                    message = 'Hebat! Hasil yang sangat baik!';
                } else if (finalScore >= 70) {
                    icon = 'ü•à';
                    message = 'Bagus! Terus tingkatkan lagi!';
                } else if (finalScore >= 60) {
                    icon = 'ü•â';
                    message = 'Cukup baik, masih bisa lebih baik lagi!';
                } else {
                    icon = 'üìö';
                    message = 'Tetap semangat! Belajar lagi ya!';
                }
                
                document.getElementById('resultIcon').textContent = icon;
                document.getElementById('resultMessage').textContent = message;
                
                // Countdown to login
                let countdown = 2;
                const countdownEl = document.getElementById('countdown');
                const countdownTimer = setInterval(() => {
                    countdown--;
                    countdownEl.textContent = countdown;
                    
                    if (countdown <= 0) {
                        clearInterval(countdownTimer);
                        this.resetToLogin();
                    }
                }, 1000);
            }

            showConfetti() {
                // Multiple confetti bursts
                const duration = 3000;
                const end = Date.now() + duration;

                (function frame() {
                    confetti({
                        particleCount: 30,
                        angle: 60,
                        spread: 55,
                        origin: { x: 0 }
                    });
                    confetti({
                        particleCount: 30,
                        angle: 120,
                        spread: 55,
                        origin: { x: 1 }
                    });

                    if (Date.now() < end) {
                        requestAnimationFrame(frame);
                    }
                }());
            }

            resetToLogin() {
                // Reset all data
                this.currentUser = null;
                this.questions = [];
                this.userAnswers = [];
                this.currentQuestionIndex = 0;
                this.score = 0;
                this.timeLeft = 50 * 60;
                this.warningCount = 0;
                this.quizCompleted = false;
                this.navigationVisible = false;
                
                // Clear form
                document.getElementById('loginForm').reset();
                
                // Show login screen
                document.getElementById('resultsScreen').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
            }
        }

        // Initialize the quiz app
        const quizApp = new QuizApp();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99017e1160be4dbc',t:'MTc2MDcyMTg5Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>

<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Data Siswa Manager</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .table-container {
      overflow-x: auto;
    }
    
    table {
      border-collapse: collapse;
    }
    
    th, td {
      text-align: left;
      padding: 12px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    th {
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    tr:hover {
      background-color: #f9fafb;
    }
    
    .loading-spinner {
      border: 3px solid #f3f4f6;
      border-top: 3px solid currentColor;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full">
  <div id="app" class="h-full w-full" style="background-color: #f3f4f6;">
   <div style="max-width: 1400px; margin: 0 auto; padding: 24px; height: 100%; overflow-auto;"><!-- Header -->
    <div style="background-color: #ffffff; border-radius: 12px; padding: 24px; margin-bottom: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
     <h1 id="app-title" style="font-size: 32px; font-weight: 700; margin: 0; color: #1f2937;">Data Siswa Manager</h1>
     <p style="margin-top: 8px; color: #6b7280; font-size: 16px;">Kelola dan analisis data siswa dengan mudah</p>
    </div><!-- Controls -->
    <div style="background-color: #ffffff; border-radius: 12px; padding: 24px; margin-bottom: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
     <div style="display: flex; gap: 16px; flex-wrap: wrap; align-items: center;">
      <div style="flex: 1; min-width: 200px;"><label for="class-filter" style="display: block; font-weight: 600; margin-bottom: 8px; color: #374151; font-size: 14px;">Filter Kelas</label> <select id="class-filter" style="width: 100%; padding: 10px 12px; border: 2px solid #d1d5db; border-radius: 8px; font-size: 14px; background-color: #ffffff; color: #1f2937; cursor: pointer;"> <option value="">Semua Kelas</option> </select>
      </div>
      <div style="display: flex; gap: 12px; align-items: flex-end;"><button id="refresh-btn" style="padding: 10px 20px; background-color: #3b82f6; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: background-color 0.2s;"> ðŸ”„ Muat Ulang </button> <button id="download-btn" style="padding: 10px 20px; background-color: #10b981; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; transition: background-color 0.2s;"> ðŸ“¥ Download Excel </button>
      </div>
     </div>
     <div id="status-message" style="margin-top: 16px; padding: 12px; border-radius: 8px; display: none; font-size: 14px;"></div>
    </div><!-- Table Container -->
    <div style="background-color: #ffffff; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
     <div id="loading-state" style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 20px;">
      <div class="loading-spinner" style="color: #3b82f6;"></div>
      <p style="margin-top: 16px; color: #6b7280; font-size: 16px;">Memuat data siswa...</p>
     </div>
     <div id="table-container" class="table-container" style="display: none;">
      <table id="students-table" style="width: 100%; background-color: #ffffff;">
       <thead>
        <tr style="background-color: #f9fafb;">
         <th style="color: #374151;">NO</th>
         <th style="color: #374151;">NAMA SISWA</th>
         <th style="color: #374151;">L/P</th>
         <th style="color: #374151;">AGAMA</th>
         <th style="color: #374151;">KELAS</th>
         <th style="color: #374151;">EKSTRAKURIKULER</th>
         <th style="color: #374151;">NILAI KUALITATIF</th>
         <th style="color: #374151;">DESKRIPSI</th>
        </tr>
       </thead>
       <tbody id="table-body">
       </tbody>
      </table>
     </div>
     <div id="empty-state" style="display: none; text-align: center; padding: 60px 20px;">
      <div style="font-size: 48px; margin-bottom: 16px;">
       ðŸ“‹
      </div>
      <p style="color: #6b7280; font-size: 18px; font-weight: 600;">Tidak ada data siswa</p>
      <p style="color: #9ca3af; font-size: 14px; margin-top: 8px;">Periksa URL Google Sheets Anda</p>
     </div>
    </div>
   </div>
  </div>
  <script>
    const defaultConfig = {
      app_title: "Data Siswa Manager",
      sheet_url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRZlP2jxYlJYN66MdMCi385WgZ2S5A7QqNJrSO_KXpE9HvYn7HMKPMtIugyUcI8fA/pub?gid=566527892&single=true&output=csv",
      primary_color: "#3b82f6",
      secondary_color: "#10b981",
      background_color: "#f3f4f6",
      surface_color: "#ffffff",
      text_color: "#1f2937"
    };

    let studentsData = [];
    let allClasses = [];

    async function onConfigChange(config) {
      const title = config.app_title || defaultConfig.app_title;
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const secondaryColor = config.secondary_color || defaultConfig.secondary_color;
      const backgroundColor = config.background_color || defaultConfig.background_color;
      const surfaceColor = config.surface_color || defaultConfig.surface_color;
      const textColor = config.text_color || defaultConfig.text_color;
      
      document.getElementById('app-title').textContent = title;
      document.getElementById('app').style.backgroundColor = backgroundColor;
      
      const surfaces = document.querySelectorAll('#app > div > div');
      surfaces.forEach(surface => {
        surface.style.backgroundColor = surfaceColor;
      });
      
      document.getElementById('refresh-btn').style.backgroundColor = primaryColor;
      document.getElementById('download-btn').style.backgroundColor = secondaryColor;
      
      const headers = document.querySelectorAll('th');
      headers.forEach(header => {
        header.style.color = textColor;
      });
      
      document.getElementById('app-title').style.color = textColor;
      
      const sheetUrl = config.sheet_url || defaultConfig.sheet_url;
      if (sheetUrl !== (window.lastLoadedUrl || defaultConfig.sheet_url)) {
        window.lastLoadedUrl = sheetUrl;
        await loadData();
      }
    }

    async function loadData() {
      const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
      const csvUrl = config.sheet_url || defaultConfig.sheet_url;
      
      showLoading();
      
      try {
        const response = await fetch(csvUrl);
        if (!response.ok) throw new Error('Gagal memuat data');
        
        const csvText = await response.text();
        const rows = csvText.split('\n').filter(row => row.trim());
        
        if (rows.length < 2) {
          showEmptyState();
          return;
        }
        
        const headers = rows[0].split(',').map(h => h.trim().replace(/"/g, ''));
        studentsData = [];
        allClasses = new Set();
        
        for (let i = 1; i < rows.length; i++) {
          const values = rows[i].split(',').map(v => v.trim().replace(/"/g, ''));
          if (values.length >= 8) {
            const student = {
              no: values[0],
              nama: values[1],
              gender: values[2],
              agama: values[3],
              kelas: values[4],
              ekstrakurikuler: values[5],
              nilai: values[6],
              deskripsi: values[7]
            };
            studentsData.push(student);
            if (student.kelas) allClasses.add(student.kelas);
          }
        }
        
        updateClassFilter();
        renderTable(studentsData);
        showSuccess(`Berhasil memuat ${studentsData.length} data siswa`);
      } catch (error) {
        showError('Gagal memuat data. Pastikan URL Google Sheets sudah benar dan dipublikasikan.');
        showEmptyState();
      }
    }

    function updateClassFilter() {
      const classFilter = document.getElementById('class-filter');
      const currentValue = classFilter.value;
      
      classFilter.innerHTML = '<option value="">Semua Kelas</option>';
      
      const sortedClasses = Array.from(allClasses).sort();
      sortedClasses.forEach(kelas => {
        const option = document.createElement('option');
        option.value = kelas;
        option.textContent = kelas;
        classFilter.appendChild(option);
      });
      
      classFilter.value = currentValue;
    }

    function renderTable(data) {
      const tbody = document.getElementById('table-body');
      tbody.innerHTML = '';
      
      if (data.length === 0) {
        showEmptyState();
        return;
      }
      
      data.forEach(student => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td style="color: #6b7280; font-weight: 500;">${student.no}</td>
          <td style="color: #1f2937; font-weight: 600;">${student.nama}</td>
          <td style="color: #6b7280;">${student.gender}</td>
          <td style="color: #6b7280;">${student.agama}</td>
          <td><span style="background-color: #dbeafe; color: #1e40af; padding: 4px 12px; border-radius: 12px; font-size: 13px; font-weight: 600;">${student.kelas}</span></td>
          <td style="color: #6b7280;">${student.ekstrakurikuler}</td>
          <td><span style="background-color: #d1fae5; color: #065f46; padding: 4px 12px; border-radius: 12px; font-size: 13px; font-weight: 600;">${student.nilai}</span></td>
          <td style="color: #6b7280; max-width: 300px;">${student.deskripsi}</td>
        `;
        tbody.appendChild(row);
      });
      
      document.getElementById('loading-state').style.display = 'none';
      document.getElementById('empty-state').style.display = 'none';
      document.getElementById('table-container').style.display = 'block';
    }

    function showLoading() {
      document.getElementById('loading-state').style.display = 'flex';
      document.getElementById('table-container').style.display = 'none';
      document.getElementById('empty-state').style.display = 'none';
    }

    function showEmptyState() {
      document.getElementById('loading-state').style.display = 'none';
      document.getElementById('table-container').style.display = 'none';
      document.getElementById('empty-state').style.display = 'block';
    }

    function showSuccess(message) {
      const statusEl = document.getElementById('status-message');
      statusEl.textContent = message;
      statusEl.style.backgroundColor = '#d1fae5';
      statusEl.style.color = '#065f46';
      statusEl.style.display = 'block';
      setTimeout(() => statusEl.style.display = 'none', 3000);
    }

    function showError(message) {
      const statusEl = document.getElementById('status-message');
      statusEl.textContent = message;
      statusEl.style.backgroundColor = '#fee2e2';
      statusEl.style.color = '#991b1b';
      statusEl.style.display = 'block';
      setTimeout(() => statusEl.style.display = 'none', 5000);
    }

    function downloadExcel() {
      const classFilter = document.getElementById('class-filter').value;
      const dataToExport = classFilter 
        ? studentsData.filter(s => s.kelas === classFilter)
        : studentsData;
      
      if (dataToExport.length === 0) {
        showError('Tidak ada data untuk diunduh');
        return;
      }
      
      const wsData = [
        ['NO', 'NAMA SISWA', 'L/P', 'AGAMA', 'KELAS', 'EKSTRAKURIKULER', 'NILAI KUALITATIF', 'DESKRIPSI']
      ];
      
      dataToExport.forEach(student => {
        wsData.push([
          student.no,
          student.nama,
          student.gender,
          student.agama,
          student.kelas,
          student.ekstrakurikuler,
          student.nilai,
          student.deskripsi
        ]);
      });
      
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(wsData);
      
      ws['!cols'] = [
        { wch: 5 },
        { wch: 25 },
        { wch: 5 },
        { wch: 12 },
        { wch: 10 },
        { wch: 20 },
        { wch: 15 },
        { wch: 40 }
      ];
      
      XLSX.utils.book_append_sheet(wb, ws, 'Data Siswa');
      
      const filename = classFilter 
        ? `data_siswa_${classFilter}.xlsx`
        : 'data_siswa_semua.xlsx';
      
      XLSX.writeFile(wb, filename);
      showSuccess(`File ${filename} berhasil diunduh`);
    }

    document.getElementById('class-filter').addEventListener('change', function() {
      const selectedClass = this.value;
      const filteredData = selectedClass 
        ? studentsData.filter(s => s.kelas === selectedClass)
        : studentsData;
      renderTable(filteredData);
    });

    document.getElementById('refresh-btn').addEventListener('click', loadData);
    document.getElementById('download-btn').addEventListener('click', downloadExcel);

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities: (config) => ({
          recolorables: [
            {
              get: () => config.background_color || defaultConfig.background_color,
              set: (value) => {
                config.background_color = value;
                window.elementSdk.setConfig({ background_color: value });
              }
            },
            {
              get: () => config.surface_color || defaultConfig.surface_color,
              set: (value) => {
                config.surface_color = value;
                window.elementSdk.setConfig({ surface_color: value });
              }
            },
            {
              get: () => config.text_color || defaultConfig.text_color,
              set: (value) => {
                config.text_color = value;
                window.elementSdk.setConfig({ text_color: value });
              }
            },
            {
              get: () => config.primary_color || defaultConfig.primary_color,
              set: (value) => {
                config.primary_color = value;
                window.elementSdk.setConfig({ primary_color: value });
              }
            },
            {
              get: () => config.secondary_color || defaultConfig.secondary_color,
              set: (value) => {
                config.secondary_color = value;
                window.elementSdk.setConfig({ secondary_color: value });
              }
            }
          ],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (config) => new Map([
          ['app_title', config.app_title || defaultConfig.app_title],
          ['sheet_url', config.sheet_url || defaultConfig.sheet_url]
        ])
      });
    } else {
      loadData();
    }
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9ade4cb22669fd89',t:'MTc2NTcyMTU4Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>